# Voice Memory - 部署与运维文档

**版本：** v1.0
**日期：** 2025-12-29
**状态：** 最终设计版本

---

## 目录

1. [部署架构](#一部署架构)
2. [本地开发环境](#二本地开发环境)
3. [Docker部署](#三docker部署)
4. [生产环境部署](#四生产环境部署)
5. [监控与日志](#五监控与日志)
6. [备份与恢复](#六备份与恢复)
7. [性能优化](#七性能优化)
8. [安全配置](#八安全配置)
9. [故障排查](#九故障排查)

---

## 一、部署架构

### 1.1 架构概览

```
┌─────────────────────────────────────────────────────────────┐
│                   Voice Memory 部署架构                       │
└─────────────────────────────────────────────────────────────┘

┌──────────────┐         ┌──────────────┐         ┌──────────────┐
│   macOS App  │         │  Terminal    │         │  iOS App     │
│   (Swift)    │         │   (Python)   │         │   (Swift)    │
└──────┬───────┘         └──────┬───────┘         └──────┬───────┘
       │                        │                        │
       │ HTTPS/WSS              │ HTTPS                 │ HTTPS
       ▼                        ▼                        ▼
┌──────────────────────────────────────────────────────────────┐
│                       Nginx / Caddy                          │
│                    (反向代理 + SSL)                           │
└───────────────────────────┬──────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────┐
│                      FastAPI 应用                             │
│                   (Uvicorn ASGI 服务器)                       │
├──────────────────────────────────────────────────────────────┤
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐        │
│  │   STT   │  │   TTS   │  │  AI API │  │ Memory  │        │
│  │ Service │  │ Service │  │ Client  │  │  Store  │        │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘        │
└──────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────┐
│  ┌──────────────┐          ┌──────────────┐                 │
│  │   SQLite     │          │ Markdown     │                 │
│  │  Database    │          │   Files      │                 │
│  └──────────────┘          └──────────────┘                 │
└──────────────────────────────────────────────────────────────┘

外部服务:
  - Anthropic API (Claude)
  - OpenAI API (Whisper, TTS)
  - Picovoice (Porcupine)
```

### 1.2 部署模式

```yaml
本地模式（MVP）:
  架构: 单机部署
  数据: 本地SQLite + Markdown
  适用: 个人用户、开发环境
  优势: 简单、隐私、免费

服务器模式:
  架构: 云服务器/VPS
  数据: 服务器SQLite + Markdown
  适用: 个人远程访问、小团队
  优势: 随时访问、数据同步

分布式模式（未来）:
  架构: 负载均衡 + 多实例
  数据: PostgreSQL + Redis
  适用: 大规模用户
  优势: 高可用、可扩展
```

---

## 二、本地开发环境

### 2.1 环境要求

```yaml
系统要求:
  macOS: 12.0+ (Monterey)
  Linux: Ubuntu 20.04+, Debian 11+
  Windows: WSL2 (推荐)

软件要求:
  Python: 3.12+
  Git: 2.30+
  Docker: 24.0+ (可选)
  Docker Compose: 2.20+ (可选)

硬件要求（开发）:
  CPU: 4核心+
  内存: 8GB+
  存储: 20GB+
```

### 2.2 快速启动

```bash
# 1. 克隆项目
git clone https://github.com/yourusername/voice-memory.git
cd voice-memory

# 2. 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# 3. 安装依赖
pip install --upgrade pip
pip install -r requirements.txt

# 4. 配置环境变量
cp .env.example .env
# 编辑.env文件，填入API密钥

# 5. 初始化数据库
python scripts/init_db.py

# 6. 启动开发服务器
uvicorn backend.main:app --reload --host 0.0.0.0 --port 8000

# 7. 访问API文档
open http://localhost:8000/docs
```

### 2.3 开发工具

```bash
# 代码格式化
black backend/ clients/ --line-length 100

# 代码检查
ruff check backend/ clients/

# 类型检查
mypy backend/ --strict

# 运行测试
pytest tests/ -v --cov=backend

# 生成测试覆盖率报告
pytest tests/ --cov=backend --cov-report=html
open htmlcov/index.html
```

---

## 三、Docker部署

### 3.1 Dockerfile

```dockerfile
# backend/Dockerfile

FROM python:3.12-slim

# 设置工作目录
WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    portaudio19-dev \
    python3-pyaudio \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# 复制依赖文件
COPY requirements.txt .

# 安装Python依赖
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY . .

# 创建存储目录
RUN mkdir -p /app/storage/markdown
RUN mkdir -p /app/storage/logs

# 暴露端口
EXPOSE 8000

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# 启动命令
CMD ["uvicorn", "backend.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### 3.2 docker-compose.yml

```yaml
version: '3.8'

services:
  api:
    build:
      context: .
      dockerfile: backend/Dockerfile
    ports:
      - "8000:8000"
    environment:
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - PICOVOICE_ACCESS_KEY=${PICOVOICE_ACCESS_KEY}
      - MEMORY_BASE_PATH=/app/storage
      - LOG_LEVEL=INFO
    volumes:
      - ./storage:/app/storage
      - ./logs:/app/logs
    env_file:
      - .env
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # 可选：Nginx反向代理
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - api
    restart: unless-stopped

  # 可选：监控
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
    restart: unless-stopped

volumes:
  prometheus-data:
  grafana-data:
```

### 3.3 Docker命令

```bash
# 构建镜像
docker-compose build

# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f api

# 停止服务
docker-compose down

# 重启服务
docker-compose restart api

# 进入容器
docker-compose exec api bash

# 查看资源使用
docker stats
```

---

## 四、生产环境部署

### 4.1 服务器配置

```yaml
推荐配置（小规模）:
  CPU: 2核心
  内存: 4GB
  存储: 40GB SSD
  带宽: 10Mbps

推荐配置（中等规模）:
  CPU: 4核心
  内存: 8GB
  存储: 80GB SSD
  带宽: 20Mbps

推荐配置（大规模）:
  CPU: 8核心+
  内存: 16GB+
  存储: 200GB SSD
  带宽: 50Mbps+
```

### 4.2 Nginx配置

```nginx
# /etc/nginx/nginx.conf

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 2048;
    use epoll;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'rt=$request_time uct="$upstream_connect_time" '
                    'uht="$upstream_header_time" urt="$upstream_response_time"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript application/xml+rss;

    # 上游服务器
    upstream voice_memory_backend {
        least_conn;
        server 127.0.0.1:8000 max_fails=3 fail_timeout=30s;
        # 多实例配置
        # server 127.0.0.1:8001 max_fails=3 fail_timeout=30s;
        # server 127.0.0.1:8002 max_fails=3 fail_timeout=30s;
    }

    # HTTP重定向到HTTPS
    server {
        listen 80;
        server_name api.voicememory.com;
        return 301 https://$server_name$request_uri;
    }

    # HTTPS服务器
    server {
        listen 443 ssl http2;
        server_name api.voicememory.com;

        # SSL配置
        ssl_certificate /etc/nginx/ssl/fullchain.pem;
        ssl_certificate_key /etc/nginx/ssl/privkey.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # 安全头
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

        # 日志
        access_log /var/log/nginx/voice_memory_access.log main;
        error_log /var/log/nginx/voice_memory_error.log warn;

        # 客户端上传限制
        client_max_body_size 100M;
        client_body_timeout 300s;

        # 代理配置
        location / {
            proxy_pass http://voice_memory_backend;
            proxy_http_version 1.1;

            # 代理头
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # 超时配置
            proxy_connect_timeout 60s;
            proxy_send_timeout 300s;
            proxy_read_timeout 300s;

            # 缓冲配置
            proxy_buffering off;
            proxy_cache off;
        }

        # WebSocket支持
        location /api/v1/ws/ {
            proxy_pass http://voice_memory_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_read_timeout 3600s;
            proxy_send_timeout 3600s;
        }

        # 健康检查
        location /health {
            proxy_pass http://voice_memory_backend/health;
            access_log off;
        }
    }
}
```

### 4.3 Systemd服务

```ini
# /etc/systemd/system/voice-memory.service

[Unit]
Description=Voice Memory API Service
After=network.target

[Service]
Type=notify
User=voicememory
Group=voicememory
WorkingDirectory=/opt/voice-memory
Environment="PATH=/opt/voice-memory/venv/bin"
EnvironmentFile=/opt/voice-memory/.env
ExecStart=/opt/voice-memory/venv/bin/uvicorn backend.main:app \
    --host 0.0.0.0 \
    --port 8000 \
    --workers 4 \
    --log-level info \
    --access-log \
    --log-config /opt/voice-memory/logging.conf
ExecReload=/bin/kill -HUP $MAINPID
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal
SyslogIdentifier=voice-memory

# 安全配置
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/opt/voice-memory/storage
ReadWritePaths=/opt/voice-memory/logs

[Install]
WantedBy=multi-user.target
```

**服务管理命令：**
```bash
# 启动服务
sudo systemctl start voice-memory

# 停止服务
sudo systemctl stop voice-memory

# 重启服务
sudo systemctl restart voice-memory

# 查看状态
sudo systemctl status voice-memory

# 开机自启
sudo systemctl enable voice-memory

# 查看日志
sudo journalctl -u voice-memory -f
```

---

## 五、监控与日志

### 5.1 日志配置

```python
# logging.conf

[loggers]
keys=root,uvicorn,voice_memory

[handlers]
keys=console,file,error_file

[formatters]
keys=default,json

[logger_root]
level=INFO
handlers=console,file

[logger_uvicorn]
level=INFO
handlers=console
qualname=uvicorn
propagate=0

[logger_voice_memory]
level=INFO
handlers=console,file,error_file
qualname=voice_memory
propagate=0

[handler_console]
class=stream.StreamHandler
level=INFO
formatter=default
args=(sys.stdout,)

[handler_file]
class=handlers.RotatingFileHandler
level=INFO
formatter=json
args=('/opt/voice-memory/logs/voice_memory.log', 'a', 10485760, 5)

[handler_error_file]
class=handlers.RotatingFileHandler
level=ERROR
formatter=json
args=('/opt/voice-memory/logs/voice_memory_error.log', 'a', 10485760, 5)

[formatter_default]
format=%(asctime)s - %(name)s - %(levelname)s - %(message)s
datefmt=%Y-%m-%d %H:%M:%S

[formatter_json]
class=pythonjsonlogger.jsonlogger.JsonFormatter
format=%(asctime)s %(name)s %(levelname)s %(message)s %(pathname)s %(lineno)d
```

### 5.2 Prometheus监控

```yaml
# monitoring/prometheus.yml

global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'voice_memory'
    static_configs:
      - targets: ['host.docker.internal:8000']
    metrics_path: '/metrics'

rule_files:
  - 'alerts.yml'

alerting:
  alertmanagers:
    - static_configs:
        - targets: ['alertmanager:9093']
```

```yaml
# monitoring/alerts.yml

groups:
  - name: voice_memory_alerts
    interval: 30s
    rules:
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value }} errors per second"

      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High response time detected"
          description: "P95 response time is {{ $value }} seconds"

      - alert: ServiceDown
        expr: up{job="voice_memory"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Service is down"
          description: "Voice Memory service has been down for more than 1 minute"
```

### 5.3 Grafana仪表板

```json
{
  "dashboard": {
    "title": "Voice Memory Dashboard",
    "panels": [
      {
        "title": "Request Rate",
        "targets": [
          {
            "expr": "rate(http_requests_total[1m])"
          }
        ]
      },
      {
        "title": "Response Time (P95)",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))"
          }
        ]
      },
      {
        "title": "Error Rate",
        "targets": [
          {
            "expr": "rate(http_requests_total{status=~\"5..\"}[5m])"
          }
        ]
      },
      {
        "title": "Active Connections",
        "targets": [
          {
            "expr": "websocket_active_connections"
          }
        ]
      }
    ]
  }
}
```

---

## 六、备份与恢复

### 6.1 备份策略

```yaml
数据库备份:
  频率: 每天一次
  保留: 30天
  方法: SQLite备份

Markdown文件备份:
  频率: 实时同步
  保留: 永久
  方法: Git版本控制

日志备份:
  频率: 每天轮转
  保留: 7天
  方法: 日志轮转
```

### 6.2 备份脚本

```bash
#!/bin/bash
# scripts/backup.sh

BACKUP_DIR="/opt/backups/voice-memory"
DATE=$(date +%Y%m%d_%H%M%S)
STORAGE_DIR="/opt/voice-memory/storage"

# 创建备份目录
mkdir -p "$BACKUP_DIR/$DATE"

# 备份SQLite数据库
echo "Backing up SQLite database..."
cp "$STORAGE_DIR/memory.db" "$BACKUP_DIR/$DATE/memory.db"

# 备份Markdown文件
echo "Backing up Markdown files..."
tar -czf "$BACKUP_DIR/$DATE/markdown.tar.gz" -C "$STORAGE_DIR" markdown/

# 备份环境配置
echo "Backing up configuration..."
cp /opt/voice-memory/.env "$BACKUP_DIR/$DATE/.env"

# 加密备份
echo "Encrypting backup..."
gpg --symmetric --cipher-algo AES256 "$BACKUP_DIR/$DATE/memory.db"
gpg --symmetric --cipher-algo AES256 "$BACKUP_DIR/$DATE/markdown.tar.gz"

# 删除未加密文件
rm "$BACKUP_DIR/$DATE/memory.db" "$BACKUP_DIR/$DATE/markdown.tar.gz"

# 上传到云存储（可选）
# aws s3 sync "$BACKUP_DIR/$DATE" s3://my-backup-bucket/voice-memory/$DATE/

# 清理旧备份（保留30天）
find "$BACKUP_DIR" -type d -mtime +30 -exec rm -rf {} \;

echo "Backup completed: $BACKUP_DIR/$DATE"
```

### 6.3 恢复脚本

```bash
#!/bin/bash
# scripts/restore.sh

BACKUP_PATH=$1

if [ -z "$BACKUP_PATH" ]; then
    echo "Usage: ./restore.sh <backup_path>"
    exit 1
fi

STORAGE_DIR="/opt/voice-memory/storage"

# 停止服务
echo "Stopping service..."
sudo systemctl stop voice-memory

# 解密备份
echo "Decrypting backup..."
gpg --output /tmp/memory.db --decrypt "$BACKUP_PATH/memory.db.gpg"
gpg --output /tmp/markdown.tar.gz --decrypt "$BACKUP_PATH/markdown.tar.gz.gpg"

# 恢复数据库
echo "Restoring database..."
cp /tmp/memory.db "$STORAGE_DIR/memory.db"

# 恢复Markdown文件
echo "Restoring Markdown files..."
tar -xzf /tmp/markdown.tar.gz -C "$STORAGE_DIR"

# 清理临时文件
rm /tmp/memory.db /tmp/markdown.tar.gz

# 启动服务
echo "Starting service..."
sudo systemctl start voice-memory

echo "Restore completed from: $BACKUP_PATH"
```

### 6.4 自动备份Cron

```bash
# /etc/cron.d/voice-memory-backup

# 每天凌晨2点执行备份
0 2 * * * voicememory /opt/voice-memory/scripts/backup.sh
```

---

## 七、性能优化

### 7.1 应用层优化

```yaml
并发优化:
  - 使用uvicorn workers多进程
  - workers数量 = (2 x CPU核心数) + 1
  - 启用asyncio异步处理

缓存策略:
  - LRU缓存常用回复
  - TTL缓存用户上下文
  - CDN缓存静态资源

数据库优化:
  - 合理使用索引
  - 批量操作减少查询
  - 连接池管理

API优化:
  - 分页返回
  - 字段选择
  - 压缩响应
```

### 7.2 Uvicorn配置

```bash
# 多worker部署
uvicorn backend.main:app \
    --host 0.0.0.0 \
    --port 8000 \
    --workers 4 \
    --worker-class uvicorn.workers.UvicornWorker \
    --limit-concurrency 1000 \
    --backlog 2048 \
    --loop uvloop \
    --http httptools \
    --log-level info \
    --access-log \
    --use-colors
```

### 7.3 Nginx优化

```nginx
# 性能优化配置

worker_processes auto;
worker_rlimit_nofile 65535;

events {
    worker_connections 4096;
    use epoll;
    multi_accept on;
}

http {
    # 缓冲区优化
    client_body_buffer_size 128k;
    client_max_body_size 100m;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 16k;

    # 超时优化
    client_body_timeout 60s;
    client_header_timeout 60s;
    keepalive_timeout 65s;
    send_timeout 60s;

    # Gzip优化
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_types text/plain text/css application/json application/javascript;

    # 连接池优化
    upstream voice_memory_backend {
        least_conn;
        server 127.0.0.1:8000 max_fails=3 fail_timeout=30s;
        keepalive 32;
    }

    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;
    proxy_busy_buffers_size 8k;
}
```

---

## 八、安全配置

### 8.1 环境变量管理

```bash
# .env（不要提交到Git）

# API密钥
ANTHROPIC_API_KEY=sk-ant-xxxxx
OPENAI_API_KEY=sk-xxxxx
PICOVOICE_ACCESS_KEY=xxxxx

# 数据库
DATABASE_URL=sqlite:///storage/memory.db

# 安全
SECRET_KEY=your-super-secret-key-change-this-in-production
ALLOWED_HOSTS=localhost,127.0.0.1,api.voicememory.com
CORS_ORIGINS=https://voicememory.com,https://www.voicememory.com

# 日志
LOG_LEVEL=INFO
LOG_FILE=/opt/voice-memory/logs/voice_memory.log

# 性能
WORKERS=4
MAX_CONNECTIONS=1000
```

### 8.2 SSL/TLS配置

```bash
# 使用Let's Encrypt免费证书

# 安装certbot
sudo apt-get install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d api.voicememory.com

# 自动续期
sudo certbot renew --dry-run
```

### 8.3 防火墙配置

```bash
# UFW防火墙规则

# 启用UFW
sudo ufw enable

# 允许SSH
sudo ufw allow 22/tcp

# 允许HTTP/HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 拒绝其他入站
sudo ufw default deny incoming

# 允许所有出站
sudo ufw default allow outgoing

# 查看状态
sudo ufw status verbose
```

---

## 九、故障排查

### 9.1 常见问题

| 问题 | 症状 | 解决方案 |
|------|------|----------|
| 服务无法启动 | 端口被占用 | `lsof -i :8000` 查看占用进程 |
| 数据库锁定 | SQLite locked | 关闭所有连接，检查是否有进程锁死 |
| 内存泄漏 | 内存持续增长 | 重启服务，检查代码中的循环引用 |
| API超时 | 请求超时 | 检查网络、增加超时时间、优化查询 |
| CPU使用高 | 响应慢 | 检查是否有死循环、优化算法 |

### 9.2 诊断命令

```bash
# 检查端口占用
lsof -i :8000

# 检查进程资源使用
top -p $(pgrep -f voice-memory)

# 检查磁盘使用
df -h

# 检查服务日志
sudo journalctl -u voice-memory -n 100

# 检查网络连接
netstat -an | grep 8000

# 检查数据库
sqlite3 /opt/voice-memory/storage/memory.db "PRAGMA integrity_check;"

# 检查API健康
curl http://localhost:8000/health

# 检查SSL证书
openssl s_client -connect api.voicememory.com:443 -servername api.voicememory.com
```

### 9.3 应急预案

```yaml
服务宕机:
  1. 检查服务状态: systemctl status voice-memory
  2. 查看错误日志: journalctl -u voice-memory -n 100
  3. 重启服务: systemctl restart voice-memory
  4. 如果无法恢复，切换到备用服务器

数据库损坏:
  1. 停止服务防止进一步损坏
  2. 导出可用数据: sqlite3 .dump
  3. 从最近备份恢复
  4. 验证数据完整性

安全事件:
  1. 立即停止服务
  2. 保留日志证据
  3. 修改所有密钥
  4. 检查数据泄露
  5. 通知用户（如有必要）
```

---

## 十、运维检查清单

### 10.1 日常检查

```yaml
每天:
  □ 检查服务状态
  □ 查看错误日志
  □ 检查磁盘空间
  □ 验证备份完成

每周:
  □ 检查性能指标
  □ 分析慢查询
  □ 检查安全日志
  □ 测试恢复流程

每月:
  □ 更新依赖版本
  □ 审查访问权限
  □ 清理旧日志
  □ 容量规划评估
```

### 10.2 监控指标

```yaml
关键指标:
  - 服务可用性: >99.9%
  - API响应时间: P95 <2s
  - 错误率: <0.1%
  - CPU使用率: <80%
  - 内存使用率: <85%
  - 磁盘使用率: <80%

告警阈值:
  - 服务宕机: 立即告警
  - 错误率>1%: 5分钟告警
  - 响应时间>5s: 5分钟告警
  - CPU>90%: 15分钟告警
  - 内存>95%: 15分钟告警
```

---

**文档版本历史：**
- v1.0 (2025-12-29): 初始版本，完整部署与运维文档
