# Voice Memory - 技术调研文档

**版本：** v0.1
**日期：** 2025-12-29
**状态：** 技术选型阶段

---

## 目录

1. [技术架构概览](#一技术架构概览)
2. [唤醒词检测](#二唤醒词检测)
3. [语音转文字 (STT)](#三语音转文字-stt)
4. [文字转语音 (TTS)](#四文字转语音-tts)
5. [AI对话引擎](#五ai对话引擎)
6. [记忆存储](#六记忆存储)
7. [技术栈决策矩阵](#七技术栈决策矩阵)
8. [备用方案与自研成本](#八备用方案与自研成本)

---

## 一、技术架构概览

### 1.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        客户端层                                  │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │ macOS App   │ │ iOS/Android │ │ Terminal    │             │
│  │ (Swift)     │ │ (Swift/Kotlin)│  │ (Python/CLI)│             │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘             │
└─────────┼─────────────────┼─────────────────┼──────────────────┘
          │                 │                 │
          └─────────────────┴─────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                      核心服务层（本地）                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                Voice Memory Core                        │   │
│  │                    (Python/FastAPI)                     │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │                                                          │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │   │
│  │  │ 唤醒词检测   │  │ 会话管理    │  │ 归档引擎    │     │   │
│  │  │ Wake Word   │  │ Session     │  │ Archive     │     │   │
│  │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘     │   │
│  │         │                │                │            │   │
│  │  ┌──────┴──────┐  ┌──────┴──────┐  ┌──────┴──────┐     │   │
│  │  │ STT/TTS     │  │ 记忆引擎    │  │ 知识图谱    │     │   │
│  │  │ 音频处理    │  │ Memory      │  │ Knowledge   │     │   │
│  │  └─────────────┘  └──────┬──────┘  └──────┬──────┘     │   │
│  │                          │                │            │   │
│  │                   ┌──────┴──────┐  ┌──────┴──────┐     │   │
│  │                   │ AI Provider │  │ 向量搜索    │     │   │
│  │                   │ 抽象层      │  │ Vector DB   │     │   │
│  │                   └─────────────┘  └─────────────┘     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                        存储层                                   │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ 文件系统      │  │ SQLite       │  │ 向量数据库    │         │
│  │ (Markdown)    │  │ (索引/元数据) │  │ (Chroma/Qdrant)│       │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────────────┘
        │
        │ (外部API调用)
        ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  OpenAI Whisper │     │  OpenAI TTS     │     │  Claude API    │
│  (STT)          │     │  (TTS)          │     │  (AI对话)       │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

### 1.2 技术选型原则

| 原则 | 说明 | 权重 |
|------|------|------|
| **隐私优先** | 本地处理可选，数据不外流 | ⭐⭐⭐⭐⭐ |
| **用户体验** | 低延迟、高准确度、自然流畅 | ⭐⭐⭐⭐⭐ |
| **可扩展性** | 支持多AI、多存储后端 | ⭐⭐⭐⭐ |
| **开发效率** | 快速迭代，社区支持 | ⭐⭐⭐⭐ |
| **成本控制** | 合理的API和基础设施成本 | ⭐⭐⭐ |

---

## 二、唤醒词检测

### 2.1 方案对比

| 方案 | 准确度 | 延迟 | 隐私 | 成本 | 平台支持 | 综合评分 |
|------|--------|------|------|------|----------|----------|
| **Picovoice Porcupine** | 91%+ | <100ms | ✅ 本地 | ⚠️ 商业昂贵 | ✅ 全平台 | ⭐⭐⭐⭐ |
| **Apple Vocal Shortcuts** | 中等 | <50ms | ✅ 本地 | ✅ 免费 | ⚠️ iOS 18+ | ⭐⭐⭐ |
| **OpenWakeWord** | 中高 | <200ms | ✅ 本地 | ✅ 开源免费 | ⚠️ 有限 | ⭐⭐⭐ |
| **自研方案** | 可控 | 可控 | ✅ 完全 | ⚠️ 高开发成本 | ✅ 全部 | ⭐⭐ |

### 2.2 详细分析

#### 方案A: Picovoice Porcupine

**技术指标：**
- **FRR（漏检率）:** <5%
- **FAR（误检率）:** 1次/10小时
- **响应延迟:** <100ms
- **CPU占用:** <5%

**优势：**
```yaml
优点:
  - 行业领先的准确度（91%+）
  - 跨平台支持（macOS, iOS, Android, Web, Linux）
  - 自定义唤醒词训练（秒级）
  - 完全本地处理，隐私友好
  - 丰富的预训练唤醒词库

缺点:
  - 商业授权价格高（$6,000+起步）
  - 免费版仅限个人非商业用途
  - 自定义词训练有数量限制
  - 闭源，无法深入定制
```

**成本分析：**
| 版本 | 价格 | 限制 |
|------|------|------|
| 免费版 | $0 | 个人、非商业、最多3个自定义词 |
| 商业版 | $6,000+ | 最低入场门槛，按量计费 |
| 企业版 | 定制 | 不限使用 |

**适用场景：**
- ✅ MVP快速验证
- ✅ 个人非商业项目
- ❌ 商业化产品（成本过高）

---

#### 方案B: Apple Vocal Shortcuts（iOS 18+）

**技术实现：**
```swift
// iOS 18+ Vocal Shortcuts API
import AppIntents

struct VoiceShortcutIntent: AppIntent {
    static var title: LocalizedStringResource = "启动Voice Memory"
    static var openAppWhenRun: Bool = true

    func perform() async throws -> some IntentResult {
        // 启动应用并开始监听
        return .result()
    }
}
```

**优势：**
```yaml
优点:
  - 完全免费，无需第三方SDK
  - 深度集成iOS系统
  - 低延迟（<50ms）
  - 隐私保护（Apple生态）
  - 无需额外权限

缺点:
  - 仅限iOS 18+（用户普及率低）
  - 自定义程度有限
  - 不支持macOS
  - 依赖Apple政策变化
```

**适用场景：**
- ✅ iOS MVP快速启动
- ❌ 跨平台产品
- ❌ 长期稳定方案

---

#### 方案C: OpenWakeWord

**技术指标：**
- **模型:** 基于深度学习的音频分类
- **准确度:** 中高（85%+）
- **响应延迟:** <200ms
- **开源:** MIT License

**优势：**
```yaml
优点:
  - 完全开源免费
  - 活跃的社区维护
  - 支持自定义训练
  - 可离线运行
  - 商业友好（MIT许可）

缺点:
  - 准确度略低于Porcupine
  - 文档相对简单
  - 商业支持有限
  - 需要自行调优
```

**适用场景：**
- ✅ 开源项目
- ✅ 成本敏感的MVP
- ✅ 需要深度定制

---

### 2.3 决策建议

**MVP阶段：** 使用 **Picovoice Porcupine**（免费版）
- 理由：快速验证，准确度高，跨平台支持

**生产阶段：** 根据用户量选择
- <1,000用户：继续Porcupine（商业授权谈判）
- >1,000用户：考虑 **自研** 或 **OpenWakeWord + 调优**

**备用方案：**
1. **iOS端：** Vocal Shortcuts（iOS 18+）
2. **跨平台：** OpenWakeWord（开源方案）
3. **终极：** 自研（见第八章）

---

## 三、语音转文字 (STT)

### 3.1 方案对比

| 方案 | 准确率(WER) | 延迟 | 隐私 | 成本 | 语言支持 | 综合评分 |
|------|------------|------|------|------|----------|----------|
| **OpenAI Whisper API** | 7.6% WER | 1-3s | ⚠️ 云端 | $0.006/分钟 | 99语言 | ⭐⭐⭐⭐⭐ |
| **Whisper 本地** | 8-10% WER | 2-5s | ✅ 完全本地 | 硬件成本 | 99语言 | ⭐⭐⭐⭐ |
| **Azure Speech** | 4-8% WER | <1s | ⚠️ 云端 | $1/小时 | 100+语言 | ⭐⭐⭐⭐ |
| **Google Cloud STT** | 4-6% WER | <1s | ⚠️ 云端 | $0.006/秒 | 125+语言 | ⭐⭐⭐⭐ |
| **Apple Speech Framework** | 中高 | <500ms | ✅ 端侧 | 免费 | 50+语言 | ⭐⭐⭐ |

### 3.2 详细分析

#### 方案A: OpenAI Whisper API

**技术指标：**
- **WER（词错误率）:** 7.6%（英语，FLEURS基准）
- **处理速度:** 最高216x实时速度
- **音频格式:** mp3, mp4, mpeg, mpga, m4a, wav, webm
- **文件大小:** 25MB
- **时长限制:** 临时文件暂存

**优势：**
```yaml
优点:
  - 行业领先的准确度
  - 99种语言支持
  - 简单易用的API
  - 快速迭代更新
  - 支持时间戳翻译

缺点:
  - 隐私顾虑（音频上传）
  - 依赖网络连接
  - API成本随规模增长
  - 中国大陆访问不稳定
```

**成本分析：**
```
定价：$0.006/分钟 = $0.36/小时

月度成本估算（按用户平均使用）：
  轻度用户（10分钟/天）:  $0.36 x 10 x 30 / 60 = $1.8/月
  中度用户（30分钟/天）:  $0.36 x 30 x 30 / 60 = $5.4/月
  重度用户（60分钟/天）:  $0.36 x 60 x 30 / 60 = $10.8/月

1000用户（平均中度）: $5.4 x 1000 = $5,400/月
```

**代码示例：**
```python
from openai import OpenAI

client = OpenAI()

audio_file = open("recording.mp3", "rb")
transcription = client.audio.transcriptions.create(
  model="whisper-1",
  file=audio_file,
  response_format="text",
  language="zh",  # 中文
  timestamp_granularities=["word"]
)

print(transcription.text)
```

---

#### 方案B: Whisper 本地部署

**技术方案：**
```python
# 使用faster-whisper加速推理
from faster_whisper import WhisperModel

model = WhisperModel("base", device="cpu", compute_type="int8")

segments, info = model.transcribe("recording.mp3", language="zh")

for segment in segments:
    print("[%.2fs -> %.2fs] %s" % (segment.start, segment.end, segment.text))
```

**性能对比：**
| 模型大小 | VRAM需求 | 相对速度 | 准确度 |
|----------|----------|----------|--------|
| tiny | 1GB | ~32x | 最低 |
| base | 1GB | ~16x | 中低 |
| small | 2GB | ~6x | 中等 |
| medium | 5GB | ~2x | 中高 |
| large-v3 | 10GB | 1x | 最高 |

**优势：**
```yaml
优点:
  - 完全隐私，数据不出设备
  - 无API调用成本
  - 可离线使用
  - 可定制优化
  - 避免网络延迟

缺点:
  - 需要硬件资源（推荐GPU）
  - 延迟高于API方案
  - 维护和更新成本
  - 需要处理模型更新
```

**硬件要求：**
| 配置 | 推荐模型 | 预期延迟 |
|------|----------|----------|
| M1/M2 Mac | small/medium | 1-2x实时 |
| Intel Mac + GPU | medium | 1-2x实时 |
| 无GPU | tiny/base | 3-5x实时 |

**成本分析：**
```
一次性成本：
  - GPU服务器（可选）: $500-2000
  - 存储空间: ~10GB（large模型）

运营成本：
  - 电费（如使用GPU）: $10-30/月
  - 维护时间: 2-4小时/月
```

---

#### 方案C: Apple Speech Framework

**技术实现：**
```swift
import Speech

let recognizer = SFSpeechRecognizer(locale: Locale(identifier: "zh-CN"))

let request = SFSpeechURLRecognitionRequest(url: audioURL)
request.shouldReportPartialResults = true

recognizer?.recognitionTask(with: request) { result, error in
    guard let result = result else { return }
    print(result.bestTranscription.formattedString)
}
```

**优势：**
```yaml
优点:
  - 完全免费
  - 端侧处理，隐私保护
  - 与Apple生态深度集成
  - 低延迟（<500ms）
  - 无网络需求

缺点:
  - 仅限Apple平台
  - 准确度略低于Whisper
  - API相对简单，定制性有限
  - 语言支持少于云端方案
```

**适用场景：**
- ✅ macOS/iOS 原生应用
- ✅ 隐私优先场景
- ❌ 跨平台需求

---

### 3.3 决策建议

**MVP策略：混合方案**

```
┌─────────────────────────────────────────────────────────┐
│                    STT路由策略                           │
└─────────────────────────────────────────────────────────┘

场景1: 隐私敏感 + 离线需求
  └─> 使用本地Whisper（base/small模型）

场景2: 实时性要求高 + 网络稳定
  └─> 使用OpenAI Whisper API

场景3: Apple平台 + 轻度使用
  └─> 使用Apple Speech Framework

场景4: 成本敏感 + 准确度要求不高
  └─> 使用本地Whisper tiny模型
```

**推荐配置（MVP）：**
- **默认：** OpenAI Whisper API（准确度优先）
- **隐私模式：** 本地Whisper base模型
- **iOS端：** Apple Speech Framework（可选）

**成本控制策略：**
1. 用户可选"隐私模式"（本地处理，节省成本）
2. 分层定价（基础版API，Pro版本地）
3. 智能缓存（重复内容不重复识别）

---

## 四、文字转语音 (TTS)

### 4.1 方案对比

| 方案 | 自然度 | 延迟 | 隐私 | 成本 | 声音多样性 | 综合评分 |
|------|--------|------|------|------|------------|----------|
| **OpenAI TTS** | 高 | 1-2s | ⚠️ 云端 | $15/1M字符 | 6种声音 | ⭐⭐⭐⭐⭐ |
| **OpenAI TTS HD** | 极高 | 2-3s | ⚠️ 云端 | $30/1M字符 | 6种声音 | ⭐⭐⭐⭐⭐ |
| **ElevenLabs** | 极高 | 1-2s | ⚠️ 云端 | $5-22/月 | 100+声音 | ⭐⭐⭐⭐ |
| **Azure Neural TTS** | 高 | <1s | ⚠️ 云端 | $16/1M字符 | 400+声音 | ⭐⭐⭐⭐ |
| **Coqui TTS** | 中高 | 2-5s | ✅ 本地 | 免费 | 1000+语言 | ⭐⭐⭐ |
| **Piper TTS** | 中 | 1-2s | ✅ 本地 | 免费 | 有限 | ⭐⭐⭐ |

### 4.2 详细分析

#### 方案A: OpenAI TTS

**技术规格：**
```yaml
模型:
  tts: 标准质量
  tts-hd: 高质量

支持格式:
  - mp3
  - opus
  - aac
  - flac
  - wav

声音选项:
  - alloy
  - echo
  - fissure
  - onyx
  - nova
  - shimmer
```

**优势：**
```yaml
优点:
  - 高质量语音输出
  - 简单易用的API
  - 低延迟（1-2s）
  - 稳定的服务质量
  - 与Whisper同生态

缺点:
  - 声音选择有限（6种）
  - 云端处理，隐私顾虑
  - API成本累积
  - 中文口音明显
```

**成本分析：**
```
定价：
  - TTS: $15/1M字符 ≈ $0.75/小时（~50K字符）
  - TTS HD: $30/1M字符 ≈ $1.50/小时

月度成本估算：
  轻度用户（10分钟/天）: 10 x 30 / 60 x $0.75 = $3.75/月
  中度用户（30分钟/天）: 30 x 30 / 60 x $0.75 = $11.25/月
  重度用户（60分钟/天）: 60 x 30 / 60 x $0.75 = $22.5/月

1000用户（平均中度）: $11,250/月
```

**代码示例：**
```python
from openai import OpenAI

client = OpenAI()

response = client.audio.speech.create(
    model="tts-1",
    voice="alloy",
    input="你好，我是你的AI记忆伴侣。"
)

response.stream_to_file("output.mp3")
```

---

#### 方案B: ElevenLabs

**技术特点：**
- **声音克隆：** 可上传30秒音频克隆声音
- **情感控制：** 调整语气、情感、语速
- **多语言：** 29种语言
- **流式输出：** 支持实时流式TTS

**优势：**
```yaml
优点:
  - 业界最佳自然度
  - 声音多样性极高（100+）
  - 声音克隆能力
  - 情感和语调控制
  - 优秀的中文支持

缺点:
  - 价格昂贵（高用量）
  - 字符限制（订阅计划）
  - 依赖网络
  - API调用限制
```

**成本分析：**
```
订阅计划：
  Free: $0/月（10K字符）
  Starter: $5/月（30K字符）
  Creator: $22/月（100K字符）
  Pro: $99/月（500K字符）

按需付费：$0.30/1K字符

成本对比（同样50K字符）：
  OpenAI TTS: $0.75
  ElevenLabs Starter: ~$15（超出部分）
  ElevenLabs Pro: $0.24

结论：高用量时ElevenLabs成本更高
```

---

#### 方案C: Coqui TTS（开源）

**技术特点：**
- **模型：** XTTS v2（多语言，高质量）
- **语言支持：** 1100+语言
- **许可：** MPL-2.0
- **平台：** 跨平台（含macOS M1/M2）

**优势：**
```yaml
优点:
  - 完全开源免费
  - 支持本地运行
  - 语言支持极广
  - 可自定义训练
  - 社区活跃

缺点:
  - 安装配置复杂
  - 质量略低于商业方案
  - 延迟较高（2-5s）
  - 需要技术维护
```

**性能：**
| 模型 | 质量 | 速度 | 显存需求 |
|------|------|------|----------|
| TTS | 中 | 快 | 2GB |
| YourTTS | 中高 | 中 | 4GB |
| XTTS v2 | 高 | 慢 | 8GB |

**成本分析：**
```
一次性成本：
  - 开发配置时间: 8-16小时
  - 服务器/存储: $0-100/月（可选）

运营成本：
  - 维护时间: 2-4小时/月
  - 电费（如使用GPU）: $10-30/月

长期ROI（>1000用户）：
  - API方案: $11,250/月
  - 自托管: $100-500/月
  - 节省: $10,000+/月
```

---

### 4.3 决策建议

**MVP阶段：OpenAI TTS**
- 理由：
  1. 高质量输出
  2. 简单集成
  3. 合理成本（MVP阶段）
  4. 与STT（Whisper）同生态

**生产阶段：分层策略**

```
┌─────────────────────────────────────────────────────────┐
│                    TTS路由策略                           │
└─────────────────────────────────────────────────────────┘

免费/基础用户:
  └─> OpenAI TTS（标准质量）

Pro用户:
  └─> OpenAI TTS HD（高质量）

企业/隐私需求:
  └─> Coqui TTS 本地部署

特殊需求（声音克隆）:
  └─> ElevenLabs（可选增值服务）
```

**优化策略：**
1. **智能缓存：** 相同文本不重复生成
2. **预生成：** 常用短语提前生成
3. **压缩存储：** 减少存储成本
4. **CDN加速：** 提升加载速度

---

## 五、AI对话引擎

### 5.1 方案对比

| 方案 | 质量 | 速度 | 上下文 | 成本 | 中文支持 | 综合评分 |
|------|------|------|--------|------|----------|----------|
| **Claude 3.5 Sonnet** | 极高 | 快 | 200K tokens | $3/1M输入 | 优秀 | ⭐⭐⭐⭐⭐ |
| **Claude 3.5 Haiku** | 高 | 极快 | 200K tokens | $0.8/1M输入 | 优秀 | ⭐⭐⭐⭐⭐ |
| **GPT-4o** | 极高 | 快 | 128K tokens | $2.5/1M输入 | 优秀 | ⭐⭐⭐⭐⭐ |
| **GPT-4o-mini** | 中高 | 极快 | 128K tokens | $0.15/1M输入 | 良好 | ⭐⭐⭐⭐ |
| **本地Llama** | 中高 | 慢 | 128K tokens | 硬件成本 | 良好 | ⭐⭐⭐ |

### 5.2 详细分析

#### 方案A: Claude 3.5 Sonnet（推荐）

**技术规格：**
```yaml
上下文窗口: 200K tokens
输入价格: $3/1M tokens
输出价格: $15/1M tokens
速度: ~50 tokens/秒
特色: 强大的推理能力，优秀的中文支持
```

**优势：**
```yaml
优点:
  - 最佳推理能力
  - 长上下文（200K tokens）
  - 自然、类人的对话风格
  - 优秀的代码理解
  - 稳定的服务质量

缺点:
  - 价格较高
  - 依赖Anthropic基础设施
  - API限制（速率限制）
```

**成本估算：**
```
典型对话（1000 tokens输入 + 500 tokens输出）：
  输入成本: 1000 / 1M x $3 = $0.003
  输出成本: 500 / 1M x $15 = $0.0075
  单次成本: $0.0105

重度用户（50次对话/天）：
  日成本: 50 x $0.0105 = $0.525
  月成本: $15.75

1000重度用户：
  月成本: $15,750
```

---

#### 方案B: Claude 3.5 Haiku（性价比之选）

**技术规格：**
```yaml
上下文窗口: 200K tokens
输入价格: $0.80/1M tokens
输出价格: $4/1M tokens
速度: ~150 tokens/秒
特色: 快速、经济、保持高质量
```

**优势：**
```yaml
优点:
  - 极快的响应速度
  - 低廉的价格
  - 长上下文支持
  - 适合简单任务

缺点:
  - 推理能力略逊于Sonnet
  - 复杂任务需要Sonnet
```

**使用建议：**
- **简单问答：** 使用Haiku
- **复杂推理：** 使用Sonnet
- **代码生成：** 使用Sonnet

---

### 5.3 决策建议

**混合策略：**

```
┌─────────────────────────────────────────────────────────┐
│                    AI路由策略                            │
└─────────────────────────────────────────────────────────┘

任务类型判断：
  ├─ 简单问答/知识检索
  │  └─> Claude 3.5 Haiku（快速、经济）
  │
  ├─ 复杂推理/创意任务
  │  └─> Claude 3.5 Sonnet（高质量）
  │
  ├─ 代码生成/技术讨论
  │  └─> Claude 3.5 Sonnet（最佳代码能力）
  │
  └─ 隐私敏感/离线需求
     └─> 本地Llama（可选）
```

**成本优化：**
1. **智能路由：** 根据任务复杂度选择模型
2. **上下文压缩：** 只发送必要信息
3. **缓存结果：** 相似问题复用答案
4. **批量处理：** 减少API调用次数

---

## 六、记忆存储

### 6.1 方案对比

| 方案 | 结构化 | 可读性 | 查询性能 | 可扩展性 | 复杂度 | 综合评分 |
|------|--------|--------|----------|----------|--------|----------|
| **Markdown + SQLite** | 中 | ✅ 极高 | 中 | 中 | 低 | ⭐⭐⭐⭐⭐ |
| **纯向量DB** | 低 | ❌ | 高 | 高 | 中 | ⭐⭐⭐⭐ |
| **Graph DB** | 高 | ❌ | 中 | 高 | 高 | ⭐⭐⭐ |
| **传统RDBMS** | 高 | ⚠️ | 高 | 高 | 中 | ⭐⭐⭐⭐ |

### 6.2 推荐方案：Markdown + SQLite（参考Basic Memory）

**架构设计：**

```yaml
存储层:
  文件系统:
    - Markdown文件（人类可读）
    - 按日期/主题组织
    - Git版本控制

  SQLite:
    - 实体索引（Entity）
    - 观察记录（Observation）
    - 关系链接（Relation）
    - 全文搜索索引

  向量数据库（可选）:
    - Chroma（轻量，本地）
    - Qdrant（生产，高性能）
```

**数据模型：**

```sql
-- 实体表（每个笔记是一个Entity）
CREATE TABLE entities (
    id INTEGER PRIMARY KEY,
    title TEXT NOT NULL,
    permalink TEXT UNIQUE,
    type TEXT DEFAULT 'note',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    metadata JSON
);

-- 观察记录（笔记中的要点）
CREATE TABLE observations (
    id INTEGER PRIMARY KEY,
    entity_id INTEGER REFERENCES entities(id),
    category TEXT,
    content TEXT NOT NULL,
    tags TEXT,
    context TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 关系表（知识图谱链接）
CREATE TABLE relations (
    id INTEGER PRIMARY KEY,
    source_entity_id INTEGER REFERENCES entities(id),
    target_entity_id INTEGER REFERENCES entities(id),
    relation_type TEXT,
    context TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Markdown格式：**

```markdown
---
title: 缸中之脑与存在性讨论
permalink: brain-in-vat-existence
tags:
  - philosophy
  - epistemology
type: note
created: 2025-12-29
---

# 缸中之脑与存在性讨论

## 观察记录

- [concept] 缸中之脑是普特宁提出的哲学思想实验 #philosophy
- [question] 如何证伪"缸中之脑"？ #未解决
- [insight] 用户提出不同年龄阶段的回答路径 #personal
  - 20岁：尝试证伪
  - 30岁：实用主义
  - 退休后：学习佛教

## 关系

- relates_to [[洞穴寓言]]
- contrasts_with [[笛卡尔恶魔]]
- inspired_by [[普特宁]]
```

**优势：**
```yaml
优点:
  - 人类可直接编辑和理解
  - Git友好的版本控制
  - 易于迁移和备份
  - Obsidian等工具兼容
  - AI和人类都可读写

缺点:
  - 大规模时性能下降
  - 并发编辑需要处理
  - 需要定期索引重建
```

---

## 七、技术栈决策矩阵

### 7.1 MVP技术栈

| 层级 | 技术选择 | 版本 | 理由 |
|------|----------|------|------|
| **唤醒词** | Picovoice Porcupine | 3.0+ | 准确度高，跨平台，免费版够用 |
| **STT** | OpenAI Whisper API | v1 | 行业最佳准确度，简单集成 |
| **STT备用** | Whisper本地（faster-whisper） | - | 隐私模式，离线支持 |
| **TTS** | OpenAI TTS | v1 | 高质量，与STT同生态 |
| **AI对话** | Claude 3.5 Haiku/Sonnet | - | 最佳质量+长上下文 |
| **后端框架** | FastAPI | 0.100+ | 现代化，异步，类型提示 |
| **存储** | Markdown + SQLite | 3.40+ | 简单、可靠、人类可读 |
| **向量DB** | Chroma | 0.4+ | 轻量，本地优先 |
| **客户端（macOS）** | Swift + SwiftUI | iOS 17+ | 原生体验，深度的系统集 |
| **CLI工具** | Python + Typer | 0.9+ | 类型安全，自动生成帮助 |

### 7.2 分阶段技术路线

```
Phase 1: MVP（4-7周）
  ├─ 唤醒词: Porcupine
  ├─ STT: OpenAI Whisper API
  ├─ TTS: OpenAI TTS
  ├─ AI: Claude Haiku/Sonnet混合
  ├─ 存储: Markdown + SQLite
  └─ 向量: Chroma

Phase 2: 优化（8-12周）
  ├─ STT: 添加本地Whisper备用
  ├─ 存储: 添加Qdrant（可选）
  ├─ 唤醒词: OpenWakeWord评估
  └─ AI: 添加本地Llama选项

Phase 3: 企业化（13-20周）
  ├─ 部署: Docker + K8s
  ├─ 监控: Prometheus + Grafana
  ├─ 日志: ELK Stack
  └─ 备份: S3兼容存储
```

---

## 八、备用方案与自研成本

### 8.1 唤醒词自研方案

**技术路线：**
```python
# 使用Sherpa-ONNX或自定义模型
import sherpa_onnx

def create_wake_word_detector():
    # 1. 数据收集（1000+样本）
    # 2. 模型训练（TensorFlow/PyTorch）
    # 3. ONNX导出和优化
    # 4. 端侧部署
    pass
```

**成本分析：**
| 阶段 | 时间 | 人力 | 硬件成本 |
|------|------|------|----------|
| 数据收集 | 2-4周 | 1人 | $0 |
| 模型训练 | 4-8周 | 1-2人 | $500-2000（GPU）|
| 优化部署 | 2-4周 | 1人 | $0 |
| 测试调优 | 2-4周 | 1人 | $0 |
| **总计** | **10-20周** | **1-2人** | **$500-2000** |

**决策点：**
- ✅ 自研条件：用户>5000，商业版成本>年收入10%
- ❌ 继续第三方：用户<1000，快速迭代

### 8.2 STT/TTS自研方案

**不推荐自研的理由：**
1. 技术门槛极高（需要ASR/TTS专业团队）
2. 数据需求巨大（数万小时标注数据）
3. 持续维护成本高
4. 开源方案质量已很高

**推荐策略：**
- 使用开源模型（Whisper, Coqui）
- 优化和微调，而非从零开始
- 聚焦应用层创新，非基础模型

### 8.3 风险缓解策略

```
┌─────────────────────────────────────────────────────────┐
│                 技术风险缓解矩阵                         │
└─────────────────────────────────────────────────────────┘

风险1: 第三方API服务中断
  缓解: 本地备用方案（Whisper, Llama）

风险2: 成本超预期
  缓解: 分层定价，智能路由，缓存优化

风险3: 隐私合规问题
  缓解: 本地优先，可选云端，数据加密

风险4: 性能瓶颈
  缓解: 异步处理，队列系统，CDN加速

风险5: 平台政策变化
  缓解: 多平台支持，开源备选方案
```

---

## 九、核心代码使用说明

### 9.1 唤醒词检测（Porcupine）

```python
import pvporcupine
import pyaudio

class WakeWordDetector:
    def __init__(self, access_key: str):
        self.porcupine = pvporcupine.create(
            access_key=access_key,
            keyword_paths=["custom_wake_word.ppn"],
            sensitivities=[0.5]
        )
        self.audio = pyaudio.PyAudio()
        self.stream = self.audio.open(
            rate=self.porcupine.sample_rate,
            channels=1,
            format=pyaudio.paInt16,
            input=True,
            frames_per_buffer=self.porcupine.frame_length
        )

    def listen(self):
        """持续监听唤醒词"""
        try:
            while True:
                pcm = self.stream.read(self.porcupine.frame_length)
                pcm = struct.unpack_from("h" * self.porcupine.frame_length, pcm)

                keyword_index = self.porcupine.process(pcm)
                if keyword_index >= 0:
                    return True  # 检测到唤醒词
        except KeyboardInterrupt:
            return False
        finally:
            self.stream.close()
            self.audio.terminate()
```

### 9.2 STT（Whisper API）

```python
from openai import OpenAI
import tempfile

class SpeechToText:
    def __init__(self, api_key: str):
        self.client = OpenAI(api_key=api_key)

    def transcribe(self, audio_data: bytes, language: str = "zh") -> str:
        """转写音频为文本"""
        # 保存临时文件
        with tempfile.NamedTemporaryFile(suffix=".mp3", delete=False) as f:
            f.write(audio_data)
            temp_path = f.name

        try:
            with open(temp_path, "rb") as audio_file:
                transcription = self.client.audio.transcriptions.create(
                    model="whisper-1",
                    file=audio_file,
                    language=language,
                    response_format="text"
                )
            return transcription
        finally:
            os.unlink(temp_path)
```

### 9.3 TTS（OpenAI TTS）

```python
from openai import OpenAI
import io

class TextToSpeech:
    def __init__(self, api_key: str):
        self.client = OpenAI(api_key=api_key)

    def synthesize(self, text: str, voice: str = "alloy") -> bytes:
        """合成语音"""
        response = self.client.audio.speech.create(
            model="tts-1",
            voice=voice,
            input=text
        )

        # 返回音频数据
        audio_data = io.BytesIO()
        for chunk in response.iter_bytes(chunk_size=4096):
            audio_data.write(chunk)

        return audio_data.getvalue()
```

### 9.4 AI对话（Claude）

```python
from anthropic import Anthropic

class AIConversation:
    def __init__(self, api_key: str):
        self.client = Anthropic(api_key=api_key)
        self.context = []  # 对话上下文

    def chat(self, user_input: str, model: str = "claude-3-5-sonnet-20241022") -> str:
        """与AI对话"""
        # 添加用户输入
        self.context.append({"role": "user", "content": user_input})

        # 调用Claude API
        response = self.client.messages.create(
            model=model,
            max_tokens=1024,
            messages=self.context
        )

        # 提取回复
        assistant_message = response.content[0].text

        # 添加到上下文
        self.context.append({"role": "assistant", "content": assistant_message})

        # 保持上下文在合理大小
        if len(self.context) > 20:
            self.context = self.context[-20:]

        return assistant_message
```

### 9.5 记忆存储（Markdown + SQLite）

```python
import sqlite3
from pathlib import Path
from datetime import datetime

class MemoryStore:
    def __init__(self, base_path: str = "~/basic-memory"):
        self.base_path = Path(base_path).expanduser()
        self.base_path.mkdir(parents=True, exist_ok=True)

        self.db_path = self.base_path / "memory.db"
        self._init_db()

    def _init_db(self):
        """初始化数据库"""
        self.conn = sqlite3.connect(self.db_path)
        self.conn.execute("""
            CREATE TABLE IF NOT EXISTS entities (
                id INTEGER PRIMARY KEY,
                title TEXT NOT NULL,
                permalink TEXT UNIQUE,
                type TEXT DEFAULT 'note',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        """)

    def save_note(self, title: str, content: str, tags: list = None) -> str:
        """保存笔记"""
        permalink = self._generate_permalink(title)

        # 保存Markdown文件
        date_str = datetime.now().strftime("%Y-%m-%d")
        file_path = self.base_path / date_str / f"{permalink}.md"
        file_path.parent.mkdir(parents=True, exist_ok=True)

        with open(file_path, "w", encoding="utf-8") as f:
            f.write(content)

        # 保存到数据库
        self.conn.execute(
            "INSERT INTO entities (title, permalink) VALUES (?, ?)",
            (title, permalink)
        )
        self.conn.commit()

        return permalink

    def search(self, query: str) -> list:
        """搜索笔记"""
        cursor = self.conn.execute(
            "SELECT title, permalink FROM entities WHERE title LIKE ?",
            (f"%{query}%",)
        )
        return cursor.fetchall()
```

---

## 十、总结与下一步

### 10.1 关键决策

| 技术领域 | MVP选择 | 理由 | 成本 |
|----------|---------|------|------|
| 唤醒词 | Porcupine | 准确度高，快速验证 | 免费（个人）|
| STT | OpenAI Whisper API | 最佳准确度 | $0.006/分钟 |
| TTS | OpenAI TTS | 高质量，简单集成 | $15/1M字符 |
| AI对话 | Claude Haiku/Sonnet | 最佳质量 | $0.8-$15/1M tokens |
| 存储 | Markdown + SQLite | 简单，人类可读 | 免费 |

### 10.2 风险评估

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| API成本超预期 | 中 | 高 | 本地备用方案，智能缓存 |
| 第三方服务中断 | 低 | 高 | 本地Whisper, 本地Llama |
| 准确度不满意 | 中 | 中 | 多模型备选，用户反馈 |
| 隐私合规问题 | 低 | 高 | 本地优先，可选云端 |

### 10.3 下一步行动

1. ✅ 技术调研完成
2. ⏳ **技术验证（1周）**
   - Porcupine唤醒词测试
   - Whisper API集成测试
   - Claude API对话测试
3. ⏳ **原型开发（2周）**
   - macOS App基础框架
   - 唤醒词 + STT + AI + TTS 流程
4. ⏳ **记忆系统（1周）**
   - Markdown + SQLite实现
   - 基础知识图谱

---

**文档版本历史：**
- v0.1 (2025-12-29): 初始版本，技术调研完成

**Sources:**
- [Picovoice Porcupine](https://picovoice.ai/platform/porcupine/)
- [OpenAI Whisper](https://openai.com/index/whisper/)
- [OpenAI TTS](https://openai.com/api/pricing/)
- [Claude 3.5 Models](https://docs.anthropic.com/)
- [Basic Memory GitHub](https://github.com/basicmachines-co/basic-memory)
- [Mem0 GitHub](https://github.com/mem0ai/mem0)
- [OpenWakeWord](https://github.com/dscripka/openWakeWord)
- [Coqui TTS](https://github.com/coqui-ai/TTS)
