<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Memory - å¯æ‰“æ–­è¯­éŸ³åŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(1.4); opacity: 0; }
        }
        .pulse-ring {
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        @keyframes recording {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .recording-indicator {
            animation: recording 1s ease-in-out infinite;
        }
        /* è¯´è¯æ—¶çš„æ³¢çº¹æ•ˆæœ */
        .speaking-wave {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            height: 20px;
        }
        .speaking-wave span {
            display: block;
            width: 4px;
            height: 100%;
            background: #a855f7;
            border-radius: 2px;
            animation: wave 1s ease-in-out infinite;
        }
        .speaking-wave span:nth-child(2) { animation-delay: 0.1s; }
        .speaking-wave span:nth-child(3) { animation-delay: 0.2s; }
        .speaking-wave span:nth-child(4) { animation-delay: 0.3s; }
        .speaking-wave span:nth-child(5) { animation-delay: 0.4s; }
        @keyframes wave {
            0%, 100% { height: 20%; }
            50% { height: 100%; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 min-h-screen text-white font-sans">
    <div class="container mx-auto px-4 py-8 max-w-xl h-screen flex flex-col">

        <!-- Header -->
        <header class="text-center mb-6 flex-shrink-0">
            <h1 class="text-3xl font-bold mb-2 bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                Voice Memory
            </h1>
            <p class="text-slate-400 text-sm">Real-time â€¢ Barge-in â€¢ Local Memory</p>
        </header>

        <!-- Chat Area (Scrollable) -->
        <main class="flex-1 overflow-y-auto bg-slate-800/30 backdrop-blur rounded-2xl border border-slate-700/50 p-4 mb-6 relative custom-scrollbar" id="chatArea">
            <div class="space-y-4" id="messages">
                <!-- Welcome Message -->
                <div class="flex justify-start">
                    <div class="max-w-[85%] p-3 rounded-2xl rounded-tl-none bg-slate-700/80 text-slate-200 text-sm shadow-sm">
                        ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯ Voice Memoryã€‚
                        <br>ç‚¹å‡»ä¸‹æ–¹éº¦å…‹é£ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å¯¹è¯ã€‚
                        <br>æ”¯æŒéšæ—¶æ‰“æ–­å“¦ï¼
                    </div>
                </div>
            </div>
            
            <!-- Real-time Status Indicator (Floating) -->
            <div id="statusIndicator" class="hidden absolute bottom-4 left-1/2 transform -translate-x-1/2 px-4 py-2 bg-slate-900/90 border border-slate-600 rounded-full shadow-xl flex items-center gap-3 z-10 transition-all duration-300">
                <!-- Content injected by JS -->
            </div>
        </main>

        <!-- Controls Area -->
        <div class="flex-shrink-0 mb-4">
            
            <!-- Transcript Preview (Real-time) -->
            <div id="transcriptPreview" class="h-12 mb-4 text-center text-slate-400 text-sm px-4 truncate transition-opacity opacity-0">
                ...
            </div>

            <!-- Main Mic Button -->
            <div class="flex justify-center items-center relative">
                <!-- Pulse Ring (Active when recording) -->
                <div id="pulseRing" class="absolute inset-0 bg-gradient-to-r from-red-500/50 to-orange-500/50 rounded-full blur-xl opacity-0 transform scale-75 transition-all duration-300"></div>
                
                <button id="recordBtn" class="relative z-10 w-20 h-20 bg-gradient-to-br from-blue-600 to-purple-600 rounded-full shadow-lg flex items-center justify-center transition-transform hover:scale-105 active:scale-95 group border-4 border-slate-800">
                    <i data-lucide="mic" class="w-8 h-8 text-white group-hover:text-white transition-colors" id="micIcon"></i>
                </button>

                <!-- Interrupt Button (Visible when speaking) -->
                <button id="interruptBtn" class="absolute right-10 top-1/2 -translate-y-1/2 hidden px-4 py-2 bg-red-500/20 text-red-400 border border-red-500/50 rounded-full text-xs font-medium hover:bg-red-500/30 transition-colors">
                    âœ‹ æ‰“æ–­
                </button>
            </div>

            <div class="text-center mt-4">
                <p id="connectionStatus" class="text-xs text-slate-600">
                    <span class="w-2 h-2 inline-block rounded-full bg-slate-500 mr-1" id="connDot"></span>
                    <span id="connText">æœªè¿æ¥</span>
                </p>
            </div>
        </div>

    </div>

    <!-- Hidden Audio Player -->
    <audio id="audioPlayer" style="display:none;"></audio>

    <!-- Load Scripts -->
    <script src="ws-client.js"></script>
    <script>
        lucide.createIcons();

        // DOM Elements
        const recordBtn = document.getElementById('recordBtn');
        const interruptBtn = document.getElementById('interruptBtn');
        const messagesDiv = document.getElementById('messages');
        const chatArea = document.getElementById('chatArea');
        const transcriptPreview = document.getElementById('transcriptPreview');
        const statusIndicator = document.getElementById('statusIndicator');
        const pulseRing = document.getElementById('pulseRing');
        const connDot = document.getElementById('connDot');
        const connText = document.getElementById('connText');
        const micIcon = document.getElementById('micIcon');

        // State
        let client = null;
        let currentAiMessageDiv = null;

        // Helper: Scroll to bottom
        function scrollToBottom() {
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // Helper: Create Message Bubble
        function appendMessage(role, text) {
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const bubble = document.createElement('div');
            bubble.className = `max-w-[85%] p-3 rounded-2xl text-sm shadow-sm ${
                role === 'user' 
                ? 'rounded-tr-none bg-blue-600 text-white' 
                : 'rounded-tl-none bg-slate-700/80 text-slate-200'
            }`;
            bubble.textContent = text;
            
            div.appendChild(bubble);
            messagesDiv.appendChild(div);
            scrollToBottom();
            return bubble; // Return for updating
        }

        // Helper: Update Status UI
        function updateStatusUI(status) {
            statusIndicator.className = 'absolute bottom-4 left-1/2 transform -translate-x-1/2 px-4 py-2 bg-slate-900/90 border border-slate-600 rounded-full shadow-xl flex items-center gap-3 z-10 transition-all duration-300'; // Reset classes
            
            switch (status) {
                case 'connected':
                    connDot.className = 'w-2 h-2 inline-block rounded-full bg-green-500 mr-1';
                    connText.textContent = 'å·²è¿æ¥';
                    statusIndicator.classList.add('hidden');
                    break;
                case 'disconnected':
                case 'error':
                    connDot.className = 'w-2 h-2 inline-block rounded-full bg-red-500 mr-1';
                    connText.textContent = 'è¿æ¥æ–­å¼€';
                    statusIndicator.classList.add('hidden');
                    pulseRing.classList.remove('scale-150', 'opacity-100');
                    break;
                case 'recording':
                    pulseRing.classList.add('scale-150', 'opacity-50'); // Show pulse
                    statusIndicator.classList.remove('hidden');
                    statusIndicator.innerHTML = `
                        <span class="relative flex h-3 w-3">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                        </span>
                        <span class="text-xs text-red-200 font-medium">æ­£åœ¨è†å¬...</span>
                    `;
                    transcriptPreview.style.opacity = 1;
                    transcriptPreview.textContent = "æ­£åœ¨å¬...";
                    break;
                case 'processing':
                    pulseRing.classList.remove('scale-150', 'opacity-50');
                    statusIndicator.classList.remove('hidden');
                    statusIndicator.innerHTML = `
                        <i data-lucide="loader-2" class="w-4 h-4 animate-spin text-blue-400"></i>
                        <span class="text-xs text-blue-200">æ€è€ƒä¸­...</span>
                    `;
                    lucide.createIcons();
                    break;
                case 'speaking':
                    statusIndicator.classList.remove('hidden');
                    statusIndicator.innerHTML = `
                        <div class="speaking-wave">
                            <span></span><span></span><span></span><span></span><span></span>
                        </div>
                        <span class="text-xs text-purple-200">æ­£åœ¨å›ç­”</span>
                    `;
                    interruptBtn.classList.remove('hidden'); // Show interrupt button
                    break;
                case 'idle':
                    pulseRing.classList.remove('scale-150', 'opacity-50');
                    statusIndicator.classList.add('hidden');
                    interruptBtn.classList.add('hidden');
                    transcriptPreview.style.opacity = 0;
                    currentAiMessageDiv = null;
                    break;
            }
        }

        // Initialize Client
        function initClient() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;

            client = new VoiceClient(
                wsUrl,
                (status) => {
                    console.log('Status:', status);
                    updateStatusUI(status);
                },
                (text, isFinal) => {
                    // Handle Transcript
                    transcriptPreview.textContent = text;
                    if (isFinal) {
                        appendMessage('user', text);
                    }
                },
                (audioData) => {
                    // Handle Audio (TTS)
                    console.log('æ”¶åˆ°éŸ³é¢‘æ•°æ®:', audioData.byteLength);
                    
                    // Create Blob and play
                    const blob = new Blob([audioData], { type: 'audio/mp3' }); // Baidu usually returns MP3
                    const url = URL.createObjectURL(blob);
                    
                    // Create AI message bubble if not exists
                    if (!currentAiMessageDiv) {
                        currentAiMessageDiv = appendMessage('assistant', 'ğŸ”Š [æ­£åœ¨æ’­æ”¾è¯­éŸ³...]');
                    }
                    
                    const audio = new Audio(url);
                    audio.className = 'tts-audio'; // Add class for selection
                    audio.onended = () => {
                        URL.revokeObjectURL(url);
                        // client.onStateChange('idle'); // Handled by server state or auto
                    };
                    audio.play().catch(e => console.error('æ’­æ”¾å¤±è´¥:', e));
                },
                () => {
                    // onSpeechStart: Stop any playing audio immediately
                    console.log('æ£€æµ‹åˆ°ç”¨æˆ·è¯´è¯ï¼Œåœæ­¢ TTS');
                    const audios = document.getElementsByClassName('tts-audio');
                    for(let a of audios) {
                        a.pause();
                        a.currentTime = 0;
                    }
                    // Optional: Send explicit interrupt to server (handled by audio stream anyway)
                }
            );
            
            client.connect();
        }

        // Initialize on load
        window.addEventListener('load', initClient);

        // Record Button Logic (Toggle)
        recordBtn.addEventListener('click', () => {
            if (!client) return;

            if (client.isRecording) {
                client.stopRecording();
                micIcon.classList.remove('text-red-500'); 
            } else {
                client.startRecording();
                micIcon.classList.add('text-red-500');
            }
        });

        // Interrupt Button
        interruptBtn.addEventListener('click', () => {
            if (client) {
                client.interrupt();
                // Stop any playing audio
                const audios = document.getElementsByTagName('audio');
                for(let a of audios) {
                    a.pause();
                    a.currentTime = 0;
                }
            }
        });

    </script>
</body>
</html>