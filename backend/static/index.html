<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Memory - ÂèØÊâìÊñ≠ËØ≠Èü≥Âä©Êâã</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Markdown Styles within Chat Bubbles */
        .prose {
            font-size: 0.95rem;
            line-height: 1.6;
        }
        .prose h1, .prose h2, .prose h3 {
            font-weight: 700;
            margin-top: 0.5em;
            margin-bottom: 0.3em;
            color: #e2e8f0; /* slate-200 */
        }
        .prose h1 { font-size: 1.2em; }
        .prose h2 { font-size: 1.1em; }
        .prose h3 { font-size: 1.05em; }
        .prose ul, .prose ol {
            margin-left: 1.2em;
            margin-bottom: 0.5em;
            list-style-type: disc;
        }
        .prose ol { list-style-type: decimal; }
        .prose li { margin-bottom: 0.2em; }
        .prose p { margin-bottom: 0.5em; }
        .prose strong { font-weight: 700; color: #f8fafc; /* slate-50 */ }
        .prose em { font-style: italic; }
        .prose code {
            background-color: rgba(30, 41, 59, 0.5); /* slate-800/50 */
            padding: 0.1em 0.3em;
            border-radius: 0.2em;
            font-family: monospace;
            font-size: 0.9em;
            color: #93c5fd; /* blue-300 */
        }
        .prose pre {
            background-color: rgba(15, 23, 42, 0.5); /* slate-900/50 */
            padding: 0.8em;
            border-radius: 0.5em;
            overflow-x: auto;
            margin-bottom: 0.5em;
        }
        .prose pre code {
            background-color: transparent;
            padding: 0;
            color: #cbd5e1; /* slate-300 */
        }
        .prose blockquote {
            border-left: 3px solid #475569; /* slate-600 */
            padding-left: 0.8em;
            color: #94a3b8; /* slate-400 */
            font-style: italic;
        }
        .prose hr {
            border-color: #334155; /* slate-700 */
            margin: 1em 0;
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(1.4); opacity: 0; }
        }
        .pulse-ring {
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        @keyframes recording {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .recording-indicator {
            animation: recording 1s ease-in-out infinite;
        }
        /* ËØ¥ËØùÊó∂ÁöÑÊ≥¢Á∫πÊïàÊûú */
        .speaking-wave {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            height: 20px;
        }
        .speaking-wave span {
            display: block;
            width: 4px;
            height: 100%;
            background: #a855f7;
            border-radius: 2px;
            animation: wave 1s ease-in-out infinite;
        }
        .speaking-wave span:nth-child(2) { animation-delay: 0.1s; }
        .speaking-wave span:nth-child(3) { animation-delay: 0.2s; }
        .speaking-wave span:nth-child(4) { animation-delay: 0.3s; }
        .speaking-wave span:nth-child(5) { animation-delay: 0.4s; }
        @keyframes wave {
            0%, 100% { height: 20%; }
            50% { height: 100%; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 min-h-screen text-white font-sans">
    <div class="container mx-auto px-4 py-8 max-w-xl h-screen flex flex-col">

        <!-- Header -->
        <header class="text-center mb-6 flex-shrink-0">
            <h1 class="text-3xl font-bold mb-2 bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                Voice Memory
            </h1>
            <p class="text-slate-400 text-sm">Real-time ‚Ä¢ Barge-in ‚Ä¢ Local Memory</p>
        </header>

        <!-- Chat Area (Scrollable) -->
        <main class="flex-1 overflow-y-auto bg-slate-800/30 backdrop-blur rounded-2xl border border-slate-700/50 p-4 mb-6 relative custom-scrollbar" id="chatArea">
            <div class="space-y-4" id="messages">
                <!-- Welcome Message -->
                <div class="flex justify-start">
                    <div class="max-w-[85%] p-3 rounded-2xl rounded-tl-none bg-slate-700/80 text-slate-200 text-sm shadow-sm">
                        üëã ‰Ω†Â•ΩÔºÅÊàëÊòØ Voice Memory„ÄÇ
                        <br>ÁÇπÂáª‰∏ãÊñπÈ∫¶ÂÖãÈ£éÔºåÊàë‰ª¨ÂèØ‰ª•Áõ¥Êé•ÂØπËØù„ÄÇ
                        <br>ÊîØÊåÅÈöèÊó∂ÊâìÊñ≠Âì¶ÔºÅ
                    </div>
                </div>
            </div>
            
            <!-- Real-time Status Indicator (Floating) -->
            <div id="statusIndicator" class="hidden absolute bottom-4 left-1/2 transform -translate-x-1/2 px-4 py-2 bg-slate-900/90 border border-slate-600 rounded-full shadow-xl flex items-center gap-3 z-10 transition-all duration-300">
                <!-- Content injected by JS -->
            </div>
        </main>

        <!-- Controls Area -->
        <div class="flex-shrink-0 mb-4 space-y-4">
            
            <!-- Transcript Preview (Real-time) -->
            <div id="transcriptPreview" class="h-6 text-center text-slate-400 text-sm px-4 truncate transition-opacity opacity-0">
                Ê≠£Âú®Âê¨...
            </div>

            <!-- Input Box & Mic -->
            <div class="flex items-center gap-3 bg-slate-800/50 p-2 rounded-2xl border border-slate-700/50">
                <!-- Mic Button (Small) -->
                <button id="recordBtn" class="w-12 h-12 flex-shrink-0 bg-blue-600 rounded-xl flex items-center justify-center transition-all hover:bg-blue-500 active:scale-95 group relative">
                    <div id="pulseRing" class="absolute inset-0 bg-blue-500 rounded-xl opacity-0"></div>
                    <i data-lucide="mic" class="w-5 h-5 text-white relative z-10" id="micIcon"></i>
                </button>

                <!-- Text Input -->
                <input type="text" id="textInput" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." class="flex-1 bg-transparent border-none focus:ring-0 text-slate-200 text-sm placeholder:text-slate-500 py-2" autocomplete="off">

                <!-- Send Button -->
                <button id="sendBtn" class="w-10 h-10 flex-shrink-0 text-slate-400 hover:text-blue-400 transition-colors">
                    <i data-lucide="send" class="w-5 h-5"></i>
                </button>
            </div>

            <div class="flex justify-between items-center px-2">
                <p id="connectionStatus" class="text-[10px] text-slate-600 uppercase tracking-widest">
                    <span class="w-1.5 h-1.5 inline-block rounded-full bg-slate-500 mr-1" id="connDot"></span>
                    <span id="connText">OFFLINE</span>
                </p>
                <button id="interruptBtn" class="hidden text-[10px] font-bold text-red-500/80 hover:text-red-400 transition-colors uppercase tracking-wider">
                    Stop AI
                </button>
            </div>
        </div>

    </div>

    <!-- Hidden Audio Player -->
    <audio id="audioPlayer" style="display:none;"></audio>

    <!-- Load Scripts -->
    <script src="ws-client.js"></script>
    <script>
        lucide.createIcons();

        // DOM Elements
        const recordBtn = document.getElementById('recordBtn');
        const textInput = document.getElementById('textInput');
        const sendBtn = document.getElementById('sendBtn');
        const interruptBtn = document.getElementById('interruptBtn');
        const messagesDiv = document.getElementById('messages');
        const chatArea = document.getElementById('chatArea');
        const transcriptPreview = document.getElementById('transcriptPreview');
        const statusIndicator = document.getElementById('statusIndicator');
        const pulseRing = document.getElementById('pulseRing');
        const connDot = document.getElementById('connDot');
        const connText = document.getElementById('connText');
        const micIcon = document.getElementById('micIcon');

        // State
        let client = null;

        // Helper: Scroll to bottom
        function scrollToBottom() {
            chatArea.scrollTo({
                top: chatArea.scrollHeight,
                behavior: 'smooth'
            });
        }

        // Helper: Create Message Bubble
        function appendMessage(role, text) {
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} animate-in fade-in slide-in-from-bottom-2 duration-300`;
            
            const bubble = document.createElement('div');
            // Base classes
            let bubbleClasses = `max-w-[85%] p-3 rounded-2xl text-sm shadow-sm leading-relaxed overflow-hidden`;
            
            if (role === 'user') {
                bubbleClasses += ` rounded-tr-none bg-blue-600 text-white`;
                bubble.className = bubbleClasses;
                bubble.textContent = text; // Plain text for user
            } else {
                bubbleClasses += ` rounded-tl-none bg-slate-700/80 text-slate-200 border border-slate-600/30 prose`; // Add prose class
                bubble.className = bubbleClasses;
                // Parse Markdown for assistant
                try {
                    bubble.innerHTML = marked.parse(text);
                } catch (e) {
                    console.error('Markdown parsing error:', e);
                    bubble.textContent = text; // Fallback
                }
            }
            
            div.appendChild(bubble);
            messagesDiv.appendChild(div);
            scrollToBottom();
            return bubble;
        }

        // Helper: Update Status UI
        function updateStatusUI(status) {
            switch (status) {
                case 'connected':
                    connDot.className = 'w-1.5 h-1.5 inline-block rounded-full bg-green-500 mr-1';
                    connText.textContent = 'Online';
                    break;
                case 'disconnected':
                case 'error':
                    connDot.className = 'w-1.5 h-1.5 inline-block rounded-full bg-red-500 mr-1';
                    connText.textContent = 'Offline';
                    pulseRing.classList.remove('animate-pulse', 'opacity-50', 'scale-125');
                    break;
                case 'recording':
                    pulseRing.classList.add('animate-pulse', 'opacity-50', 'scale-125');
                    transcriptPreview.style.opacity = 1;
                    transcriptPreview.textContent = "Ê≠£Âú®ËÅÜÂê¨...";
                    break;
                case 'processing':
                    pulseRing.classList.remove('animate-pulse', 'opacity-50', 'scale-125');
                    statusIndicator.classList.remove('hidden');
                    statusIndicator.innerHTML = `
                        <i data-lucide="loader-2" class="w-4 h-4 animate-spin text-blue-400"></i>
                        <span class="text-xs text-blue-200">AI Ê≠£Âú®ÊÄùËÄÉ...</span>
                    `;
                    lucide.createIcons();
                    break;
                case 'speaking':
                    statusIndicator.classList.remove('hidden');
                    statusIndicator.innerHTML = `
                        <div class="speaking-wave">
                            <span></span><span></span><span></span><span></span><span></span>
                        </div>
                        <span class="text-xs text-purple-200">Ê≠£Âú®ÂõûÁ≠î...</span>
                    `;
                    interruptBtn.classList.remove('hidden');
                    break;
                case 'idle':
                    pulseRing.classList.remove('animate-pulse', 'opacity-50', 'scale-125');
                    statusIndicator.classList.add('hidden');
                    interruptBtn.classList.add('hidden');
                    transcriptPreview.style.opacity = 0;
                    micIcon.classList.remove('text-red-400');
                    break;
            }
        }

        // Handle Text Send
        function handleTextSend() {
            const text = textInput.value.trim();
            if (!text || !client) return;
            
            appendMessage('user', text);
            client.sendText(text);
            textInput.value = '';
        }

        // Initialize Client
        function initClient() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;

            client = new VoiceClient(
                wsUrl,
                updateStatusUI,
                (text, isFinal) => {
                    // Handle Transcript
                    if (isFinal) {
                        appendMessage('user', text);
                        transcriptPreview.style.opacity = 0;
                    } else {
                        transcriptPreview.textContent = text;
                        transcriptPreview.style.opacity = 1;
                    }
                },
                (audioData) => {
                    console.log('Audio received:', audioData.byteLength);
                },
                () => {
                    console.log('Speech detected');
                },
                (text) => {
                    appendMessage('assistant', text);
                }
            );
            
            client.connect();
        }

        // Event Listeners
        window.addEventListener('load', initClient);

        recordBtn.addEventListener('click', () => {
            if (!client) return;
            if (client.isRecording) {
                client.stopRecording();
            } else {
                client.startRecording();
                micIcon.classList.add('text-red-400');
            }
        });

        sendBtn.addEventListener('click', handleTextSend);
        textInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleTextSend();
        });

        interruptBtn.addEventListener('click', () => {
            if (client) client.interrupt();
        });

    </script>
</body>
</html>