<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Memory - è¯­éŸ³çŸ¥è¯†åº“</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(1.4); opacity: 0; }
        }
        .pulse-ring {
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        @keyframes recording {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .recording-indicator {
            animation: recording 1s ease-in-out infinite;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 min-h-screen text-white">
    <div class="container mx-auto px-4 py-8 max-w-2xl">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                ğŸ¤ Voice Memory
            </h1>
            <p class="text-slate-400">è¯­éŸ³è®°å½• â†’ AI æ•´ç† â†’ çŸ¥è¯†åº“ (ç™¾åº¦ STT + æ™ºè°± GLM)</p>
        </header>

        <!-- Main Card -->
        <main class="bg-slate-800/50 backdrop-blur rounded-2xl shadow-2xl border border-slate-700 p-8">

            <!-- Record Button -->
            <div class="flex justify-center mb-8">
                <button id="recordBtn" class="group relative">
                    <div id="pulseRing" class="absolute inset-0 bg-gradient-to-r from-red-500 to-orange-500 rounded-full blur-xl opacity-0"></div>
                    <div class="relative bg-gradient-to-r from-blue-500 to-purple-500 rounded-full p-8 transition-transform group-hover:scale-105">
                        <i data-lucide="mic" class="w-12 h-12 text-white"></i>
                    </div>
                </button>
            </div>

            <!-- Status -->
            <div class="text-center mb-8">
                <div id="status" class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-slate-700/50 text-slate-300">
                    <span class="w-2 h-2 rounded-full bg-slate-500" id="statusDot"></span>
                    <span id="statusText">ç‚¹å‡»éº¦å…‹é£å¼€å§‹å½•éŸ³</span>
                </div>
                <div id="recordingTime" class="text-2xl font-mono mt-2 hidden">00:00</div>
            </div>

            <!-- Transcript Display -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-slate-400 mb-2">
                    è¾“å…¥å†…å®¹ (Ctrl+Enter å‘é€)
                </label>
                <textarea id="transcript" class="min-h-[100px] w-full p-4 bg-slate-900/50 rounded-xl border border-slate-700 text-white text-sm resize-none focus:outline-none focus:border-blue-500" placeholder="å½•éŸ³è¯†åˆ«æˆ–ç›´æ¥è¾“å…¥æ–‡å­—..."></textarea>
                <div class="flex items-center justify-between mt-2">
                    <span class="text-xs text-slate-500">
                        <span id="charCount">0</span> å­—ç¬¦
                    </span>
                    <button id="clearInputBtn" class="flex items-center gap-1 px-2 py-1 text-xs bg-slate-700 text-slate-300 rounded hover:bg-slate-600 transition-colors">
                        <i data-lucide="x" class="w-3 h-3"></i>
                        æ¸…ç©º
                    </button>
                </div>
            </div>

            <!-- AI Reply Display -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-2">
                    <label class="block text-sm font-medium text-slate-400">
                        AI å›å¤
                    </label>
                    <button id="playVoiceBtn" class="flex items-center gap-1 px-3 py-1 text-xs bg-purple-500/20 text-purple-300 rounded-lg hover:bg-purple-500/30 transition-colors disabled:opacity-50" disabled>
                        <i data-lucide="volume-2" class="w-3 h-3"></i>
                        æ’­æ”¾è¯­éŸ³
                    </button>
                </div>
                <div id="aiReply" class="min-h-[100px] p-4 bg-slate-900/50 rounded-xl border border-slate-700 text-slate-300">
                    <span class="text-slate-600 italic">AI å›å¤å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</span>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-3 gap-4">
                <button id="sendBtn" class="py-3 px-4 bg-gradient-to-r from-green-500 to-emerald-500 rounded-xl font-medium hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed text-sm" disabled>
                    <span class="flex items-center justify-center gap-2">
                        <i data-lucide="message-circle" class="w-4 h-4"></i>
                        AI å¯¹è¯
                    </span>
                </button>
                <button id="saveKnowledgeBtn" class="py-3 px-4 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-xl font-medium hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed text-sm" disabled>
                    <span class="flex items-center justify-center gap-2">
                        <i data-lucide="database" class="w-4 h-4"></i>
                        ä¿å­˜çŸ¥è¯†
                    </span>
                </button>
                <button id="clearBtn" class="py-3 px-4 bg-slate-700 rounded-xl font-medium hover:bg-slate-600 transition-colors text-sm">
                    <span class="flex items-center justify-center gap-2">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                        æ¸…é™¤
                    </span>
                </button>
            </div>

            <!-- Knowledge List -->
            <div class="mt-6">
                <div class="flex items-center justify-between mb-2">
                    <label class="block text-sm font-medium text-slate-400">
                        æˆ‘çš„çŸ¥è¯†åº“
                    </label>
                    <button id="refreshKnowledgeBtn" class="flex items-center gap-1 px-2 py-1 text-xs bg-slate-700 text-slate-300 rounded hover:bg-slate-600 transition-colors">
                        <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                        åˆ·æ–°
                    </button>
                </div>
                <div id="knowledgeList" class="min-h-[150px] max-h-[300px] overflow-y-auto p-4 bg-slate-900/50 rounded-xl border border-slate-700 text-slate-300 space-y-2">
                    <span class="text-slate-600 italic text-sm">çŸ¥è¯†åº“å†…å®¹å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</span>
                </div>
            </div>

            <!-- All Sessions List -->
            <div class="mt-6">
                <div class="flex items-center justify-between mb-2">
                    <label class="block text-sm font-medium text-slate-400">
                        ğŸ’¬ æ‰€æœ‰å¯¹è¯è®°å½•
                    </label>
                    <button id="refreshSessionsBtn" class="flex items-center gap-1 px-2 py-1 text-xs bg-slate-700 text-slate-300 rounded hover:bg-slate-600 transition-colors">
                        <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                        åˆ·æ–°
                    </button>
                </div>
                <div id="sessionsList" class="min-h-[150px] max-h-[400px] overflow-y-auto p-4 bg-slate-900/50 rounded-xl border border-slate-700 text-slate-300 space-y-2">
                    <span class="text-slate-600 italic text-sm">å¯¹è¯è®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</span>
                </div>
            </div>

            <!-- Debug Info -->
            <details class="mt-6">
                <summary class="cursor-pointer text-sm text-slate-400 hover:text-slate-300">
                    ğŸ› ï¸ è°ƒè¯•ä¿¡æ¯
                </summary>
                <div class="mt-3 bg-slate-900/80 rounded-xl p-4 border border-slate-700 text-sm">
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <div>
                            <span class="text-slate-500">åç«¯çŠ¶æ€:</span>
                            <span id="backendStatus" class="ml-2 text-yellow-400">æ£€æµ‹ä¸­...</span>
                        </div>
                        <div>
                            <span class="text-slate-500">å½•éŸ³æ—¶é•¿:</span>
                            <span id="recordDuration" class="ml-2">0s</span>
                        </div>
                        <div>
                            <span class="text-slate-500">éŸ³é¢‘å¤§å°:</span>
                            <span id="audioSize" class="ml-2">0 KB</span>
                        </div>
                        <div>
                            <span class="text-slate-500">éŸ³é¢‘æ ¼å¼:</span>
                            <span id="audioFormat" class="ml-2">WAV/PCM</span>
                        </div>
                    </div>
                    <div>
                        <label class="text-slate-500 block mb-1">é€‰æ‹©éº¦å…‹é£:</label>
                        <select id="micSelect" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white text-sm">
                            <option value="">æ£€æµ‹éº¦å…‹é£è®¾å¤‡...</option>
                        </select>
                    </div>
                </div>
            </details>

            <!-- Info -->
            <div class="mt-6 p-4 bg-blue-500/10 border border-blue-500/20 rounded-xl">
                <div class="flex items-start gap-3">
                    <i data-lucide="database" class="w-5 h-5 text-blue-400 mt-0.5 flex-shrink-0"></i>
                    <div class="text-sm text-blue-300">
                        <p class="font-medium mb-1">è¯­éŸ³çŸ¥è¯†åº“ MVP</p>
                        <ul class="space-y-1 text-blue-300/80">
                            <li>â€¢ è¯­éŸ³å½•åˆ¶ â†’ STT è¯†åˆ«</li>
                            <li>â€¢ AI è‡ªåŠ¨åˆ†ç±»å’Œæå–å…³é”®ç‚¹</li>
                            <li>â€¢ ä¿å­˜åˆ°ä¸ªäººçŸ¥è¯†åº“</li>
                            <li>â€¢ çŸ¥è¯†åˆ—è¡¨å’Œç»Ÿè®¡</li>
                            <li>â€¢ æ”¯æŒ AI å¯¹è¯æ¨¡å¼</li>
                        </ul>
                    </div>
                </div>
            </div>

        </main>

        <!-- Audio Player (éšè—) -->
        <audio id="audioPlayer" style="display:none;"></audio>

        <!-- Footer -->
        <footer class="text-center mt-8 text-slate-500 text-sm">
            Voice Memory â€¢ è¯­éŸ³è¾“å…¥ â†’ AI æ•´ç† â†’ çŸ¥è¯†æ²‰æ·€
        </footer>

    </div>

    <script>
        // é…ç½® - ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆå‰åç«¯åŒåŸŸï¼‰
        const API_BASE_URL = '';  // ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºç›¸å¯¹è·¯å¾„ï¼Œè‡ªåŠ¨ä½¿ç”¨å½“å‰åŸŸå
        const SAMPLE_RATE = 16000;  // ç™¾åº¦è¦æ±‚ 16kHz

        // Initialize icons
        lucide.createIcons();

        // DOM å…ƒç´ 
        const recordBtn = document.getElementById('recordBtn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const transcript = document.getElementById('transcript');
        const charCount = document.getElementById('charCount');
        const clearInputBtn = document.getElementById('clearInputBtn');
        const aiReply = document.getElementById('aiReply');
        const sendBtn = document.getElementById('sendBtn');
        const saveKnowledgeBtn = document.getElementById('saveKnowledgeBtn');
        const clearBtn = document.getElementById('clearBtn');
        const playVoiceBtn = document.getElementById('playVoiceBtn');
        const pulseRing = document.getElementById('pulseRing');
        const recordingTime = document.getElementById('recordingTime');
        const micSelect = document.getElementById('micSelect');
        const backendStatus = document.getElementById('backendStatus');
        const recordDuration = document.getElementById('recordDuration');
        const audioSize = document.getElementById('audioSize');
        const knowledgeList = document.getElementById('knowledgeList');
        const refreshKnowledgeBtn = document.getElementById('refreshKnowledgeBtn');
        const sessionsList = document.getElementById('sessionsList');
        const refreshSessionsBtn = document.getElementById('refreshSessionsBtn');
        const audioPlayer = document.getElementById('audioPlayer');

        // çŠ¶æ€å˜é‡
        let isRecording = false;
        let audioContext = null;
        let mediaStream = null;
        let processor = null;
        let audioChunks = [];
        let recordingStartTime = null;
        let recordingTimer = null;
        let selectedDeviceId = null;
        let sessionId = null;  // ä¼šè¯ IDï¼Œç”¨äºå¤šè½®å¯¹è¯
        let lastAiReply = '';  // æœ€è¿‘çš„ AI å›å¤ï¼Œç”¨äº TTS æ’­æ”¾
        let lastAudioBlob = null;  // ä¿å­˜æœ€è¿‘çš„éŸ³é¢‘ blobï¼Œç”¨äºçŸ¥è¯†åº“è®°å½•
        let lastRecognizedText = '';  // ä¿å­˜æœ€è¿‘çš„è¯†åˆ«æ–‡æœ¬

        // ===== WAV ç¼–ç å™¨ =====
        function encodeWAV(samples, sampleRate) {
            const buffer = new ArrayBuffer(44 + samples.length * 2);
            const view = new DataView(buffer);

            // RIFF æ ‡è¯†
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + samples.length * 2, true);
            writeString(view, 8, 'WAVE');

            // fmt å­å—
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);  // fmt å—å¤§å°
            view.setUint16(20, 1, true);   // PCM æ ¼å¼
            view.setUint16(22, 1, true);   // å•å£°é“
            view.setUint32(24, sampleRate, true);  // é‡‡æ ·ç‡
            view.setUint32(28, sampleRate * 2, true);  // å­—èŠ‚ç‡
            view.setUint16(32, 2, true);   // å—å¯¹é½
            view.setUint16(34, 16, true);  // ä½æ·±åº¦

            // data å­å—
            writeString(view, 36, 'data');
            view.setUint32(40, samples.length * 2, true);

            // å†™å…¥ PCM æ•°æ®
            floatTo16BitPCM(view, 44, samples);

            return new Blob([view], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        function floatTo16BitPCM(view, offset, samples) {
            for (let i = 0; i < samples.length; i++, offset += 2) {
                const s = Math.max(-1, Math.min(1, samples[i]));
                view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
            }
        }

        // ===== æ£€æŸ¥åç«¯çŠ¶æ€ =====
        async function checkBackend() {
            try {
                const resp = await fetch(`${API_BASE_URL}/health`);
                if (resp.ok) {
                    backendStatus.textContent = 'âœ… åœ¨çº¿';
                    backendStatus.className = 'ml-2 text-green-400';
                    return true;
                }
            } catch (e) {
                backendStatus.textContent = 'âŒ ç¦»çº¿';
                backendStatus.className = 'ml-2 text-red-400';
                return false;
            }
        }

        // ===== æšä¸¾éº¦å…‹é£è®¾å¤‡ =====
        async function enumerateMicrophones() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioInputs = devices.filter(d => d.kind === 'audioinput');

                micSelect.innerHTML = '';
                audioInputs.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.textContent = device.label || `éº¦å…‹é£ ${index + 1}`;
                    micSelect.appendChild(option);
                });

                console.log(`æ‰¾åˆ° ${audioInputs.length} ä¸ªéº¦å…‹é£è®¾å¤‡`);
            } catch (error) {
                console.error('æšä¸¾è®¾å¤‡å¤±è´¥:', error);
            }
        }

        // ===== å¼€å§‹å½•éŸ³ =====
        async function startRecording() {
            try {
                const constraints = {
                    audio: selectedDeviceId ? { deviceId: { exact: selectedDeviceId } } : true
                };

                mediaStream = await navigator.mediaDevices.getUserMedia(constraints);

                // åˆ›å»º AudioContext
                audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: SAMPLE_RATE });
                const source = audioContext.createMediaStreamSource(mediaStream);
                processor = audioContext.createScriptProcessor(4096, 1, 1);

                audioChunks = [];

                processor.onaudioprocess = (e) => {
                    if (isRecording) {
                        const inputData = e.inputBuffer.getChannelData(0);
                        audioChunks.push(new Float32Array(inputData));
                    }
                };

                source.connect(processor);
                processor.connect(audioContext.destination);

                recordingStartTime = Date.now();

                // æ›´æ–° UI
                isRecording = true;
                statusDot.className = 'w-2 h-2 rounded-full bg-red-500 recording-indicator';
                statusText.textContent = 'æ­£åœ¨å½•éŸ³... (å†æ¬¡ç‚¹å‡»åœæ­¢)';
                pulseRing.classList.add('pulse-ring');
                recordingTime.classList.remove('hidden');

                // å¯åŠ¨è®¡æ—¶å™¨
                recordingTimer = setInterval(updateRecordingTime, 100);

            } catch (error) {
                console.error('å½•éŸ³å¤±è´¥:', error);
                alert('å½•éŸ³å¤±è´¥: ' + error.message);
            }
        }

        // ===== åœæ­¢å½•éŸ³ =====
        function stopRecording() {
            if (!audioContext) return;

            // æ–­å¼€è¿æ¥
            if (processor) {
                processor.disconnect();
            }

            // åœæ­¢éŸ³é¢‘æµ
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }

            // å…³é—­ AudioContext
            audioContext.close();

            // åœæ­¢è®¡æ—¶å™¨
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }

            // æ›´æ–° UI
            isRecording = false;
            statusDot.className = 'w-2 h-2 rounded-full bg-yellow-500 animate-pulse';
            statusText.textContent = 'æ­£åœ¨è¯†åˆ«...';
            pulseRing.classList.remove('pulse-ring');

            // åˆå¹¶éŸ³é¢‘æ•°æ®å¹¶ç¼–ç ä¸º WAV
            const totalLength = audioChunks.reduce((sum, chunk) => sum + chunk.length, 0);
            const samples = new Float32Array(totalLength);
            let offset = 0;
            for (const chunk of audioChunks) {
                samples.set(chunk, offset);
                offset += chunk.length;
            }

            const wavBlob = encodeWAV(samples, SAMPLE_RATE);
            audioSize.textContent = (wavBlob.size / 1024).toFixed(1) + ' KB';
            console.log(`å½•éŸ³ç»“æŸï¼Œå¤§å°: ${(wavBlob.size / 1024).toFixed(1)} KB`);

            // ä¸Šä¼ è¯†åˆ«
            uploadAndRecognize(wavBlob);
        }

        // ===== æ›´æ–°å½•éŸ³æ—¶é•¿ =====
        function updateRecordingTime() {
            const elapsed = Date.now() - recordingStartTime;
            const seconds = Math.floor(elapsed / 1000);
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;

            recordingTime.textContent =
                String(minutes).padStart(2, '0') + ':' + String(secs).padStart(2, '0');

            recordDuration.textContent = seconds + 's';
        }

        // ===== ä¸Šä¼ å¹¶è¯†åˆ« =====
        async function uploadAndRecognize(audioBlob) {
            try {
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.wav');
                formData.append('format', 'wav');

                const response = await fetch(`${API_BASE_URL}/api/stt`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success && result.result && result.result.length > 0) {
                    const text = result.result[0];
                    // å¡«å……åˆ°è¾“å…¥æ¡†
                    transcript.value = text;
                    lastRecognizedText = text;
                    lastAudioBlob = audioBlob;
                    updateInputState();
                    console.log('è¯†åˆ«ç»“æœ:', text);
                } else {
                    throw new Error(result.error || 'è¯†åˆ«å¤±è´¥');
                }

            } catch (error) {
                console.error('è¯†åˆ«å¤±è´¥:', error);
                transcript.value = 'è¯†åˆ«å¤±è´¥: ' + error.message;
                updateInputState();
            } finally {
                // é‡ç½®çŠ¶æ€
                statusDot.className = 'w-2 h-2 rounded-full bg-slate-500';
                statusText.textContent = 'ç‚¹å‡»éº¦å…‹é£å¼€å§‹å½•éŸ³';
                recordingTime.classList.add('hidden');
            }
        }

        // ===== æ›´æ–°è¾“å…¥çŠ¶æ€ =====
        function updateInputState() {
            const text = transcript.value.trim();
            charCount.textContent = text.length;
            lastRecognizedText = text;
            sendBtn.disabled = text.length === 0;
            saveKnowledgeBtn.disabled = text.length === 0;
        }

        // ===== ä¿å­˜åˆ°çŸ¥è¯†åº“ =====
        async function saveToKnowledge() {
            if (!lastRecognizedText) {
                alert('æ²¡æœ‰å¯ä¿å­˜çš„å†…å®¹');
                return;
            }

            saveKnowledgeBtn.disabled = true;
            saveKnowledgeBtn.innerHTML = '<span class="flex items-center justify-center gap-2"><i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>ä¿å­˜ä¸­...</span>';
            lucide.createIcons();

            try {
                const formData = new FormData();
                // å¦‚æœæœ‰éŸ³é¢‘å°±ä¼ éŸ³é¢‘ï¼ŒåŒæ—¶ä¼ å…¥ç¼–è¾‘åçš„æ–‡æœ¬
                if (lastAudioBlob) {
                    formData.append('audio', lastAudioBlob, 'recording.wav');
                }
                // ä¼ å…¥ç¼–è¾‘åçš„æ–‡æœ¬
                formData.append('text', lastRecognizedText);
                formData.append('auto_organize', 'true');
                // ä¼ å…¥ä¼šè¯IDï¼Œå…³è”å®Œæ•´çš„å¤šè½®å¯¹è¯å†å²
                if (sessionId) {
                    formData.append('session_id', sessionId);
                }

                const response = await fetch(`${API_BASE_URL}/api/knowledge/record`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success) {
                    const titleText = result.knowledge.title ? `\næ ‡é¢˜: ${result.knowledge.title}` : '';
                    alert(`âœ… ä¿å­˜æˆåŠŸï¼\n\n${titleText}\nåˆ†ç±»: ${result.knowledge.category}\næ‘˜è¦: ${result.knowledge.summary}`);

                    // ä¿å­˜æˆåŠŸåå¼€å¯æ–°ä¼šè¯
                    sessionId = '';
                    lastAiReply = '';
                    lastRecognizedText = '';
                    transcript.value = '';
                    aiReply.innerHTML = '<span class="text-slate-600 italic">AI å›å¤å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</span>';

                    // åˆ·æ–°åˆ—è¡¨
                    await loadKnowledgeList();
                    await loadSessionsList();
                    updateInputState();
                } else {
                    throw new Error(result.error || 'ä¿å­˜å¤±è´¥');
                }

            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            } finally {
                saveKnowledgeBtn.disabled = false;
                saveKnowledgeBtn.innerHTML = '<span class="flex items-center justify-center gap-2"><i data-lucide="database" class="w-4 h-4"></i>ä¿å­˜çŸ¥è¯†</span>';
                lucide.createIcons();
            }
        }

        // ===== åŠ è½½çŸ¥è¯†åº“åˆ—è¡¨ =====
        async function loadKnowledgeList() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/knowledge/list`);
                if (!response.ok) throw new Error('åŠ è½½å¤±è´¥');

                const result = await response.json();

                if (result.success && result.knowledges && result.knowledges.length > 0) {
                    knowledgeList.innerHTML = result.knowledges.map(k => `
                        <div class="knowledge-item bg-slate-800/50 rounded-lg border border-slate-700/50 overflow-hidden" data-id="${k.id}" data-session="${k.session_id || ''}">
                            <!-- å¯ç‚¹å‡»çš„å¤´éƒ¨ -->
                            <div class="item-header p-3 cursor-pointer hover:bg-slate-700/30 transition-colors" onclick="toggleConversation('${k.id}', '${k.session_id || ''}', this)">
                                <div class="flex items-start justify-between gap-2">
                                    <div class="flex-1 min-w-0">
                                        ${k.title ? `<h3 class="text-base font-medium text-white mb-2 flex items-center gap-2"><i data-lucide="bookmark" class="w-4 h-4 text-blue-400"></i>${k.title}</h3>` : ''}
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="px-2 py-0.5 text-xs rounded-full bg-blue-500/20 text-blue-300">${k.category}</span>
                                            <span class="text-xs text-slate-500">${new Date(k.created_at).toLocaleString()}</span>
                                            ${k.session_id ? '<span class="px-2 py-0.5 text-xs rounded-full bg-green-500/20 text-green-300">ğŸ’¬ å¯¹è¯</span>' : ''}
                                        </div>
                                        <p class="text-sm text-slate-300 mb-1">${k.content}</p>
                                        ${k.summary ? `<p class="text-xs text-slate-500 italic">æ‘˜è¦: ${k.summary}</p>` : ''}
                                    </div>
                                    <i data-lucide="chevron-down" class="w-4 h-4 text-slate-500 flex-shrink-0 transition-transform duration-200"></i>
                                </div>
                            </div>
                            <!-- å¯¹è¯å†…å®¹åŒºåŸŸ -->
                            <div class="conversation-content hidden bg-slate-900/50 border-t border-slate-700/50" id="conv-${k.id}">
                                <div class="p-3 text-slate-500 text-sm text-center">åŠ è½½ä¸­...</div>
                            </div>
                        </div>
                    `).join('');

                    lucide.createIcons();

                    // æ›´æ–°ç»Ÿè®¡
                    if (result.stats) {
                        knowledgeList.innerHTML += `
                            <div class="mt-3 pt-3 border-t border-slate-700 text-xs text-slate-500 text-center">
                                å…± ${result.stats.total || 0} æ¡è®°å½•
                            </div>
                        `;
                    }
                } else {
                    knowledgeList.innerHTML = '<span class="text-slate-600 italic text-sm">çŸ¥è¯†åº“ä¸ºç©ºï¼Œå¼€å§‹è®°å½•å§...</span>';
                }
            } catch (error) {
                console.error('åŠ è½½çŸ¥è¯†åº“å¤±è´¥:', error);
            }
        }

        // å±•å¼€/æ”¶èµ·å¯¹è¯å†…å®¹
        async function toggleConversation(knowledgeId, sessionId, headerElement) {
            const contentDiv = document.getElementById(`conv-${knowledgeId}`);
            const chevronIcon = headerElement.querySelector('[data-lucide="chevron-down"]');

            // å¦‚æœå·²ç»å±•å¼€ï¼Œåˆ™æ”¶èµ·
            if (!contentDiv.classList.contains('hidden')) {
                contentDiv.classList.add('hidden');
                chevronIcon.style.transform = 'rotate(0deg)';
                return;
            }

            // å¦‚æœæ²¡æœ‰ä¼šè¯ï¼Œæç¤ºç”¨æˆ·
            if (!sessionId) {
                contentDiv.classList.remove('hidden');
                contentDiv.innerHTML = '<div class="p-3 text-slate-500 text-sm text-center">è¯¥çŸ¥è¯†æ¡ç›®æ²¡æœ‰å…³è”çš„å¯¹è¯å†å²</div>';
                chevronIcon.style.transform = 'rotate(180deg)';
                return;
            }

            // åŠ è½½å¯¹è¯å†…å®¹
            contentDiv.classList.remove('hidden');
            contentDiv.innerHTML = '<div class="p-3 text-slate-500 text-sm text-center">åŠ è½½ä¸­...</div>';
            chevronIcon.style.transform = 'rotate(180deg)';

            try {
                const sessResp = await fetch(`${API_BASE_URL}/api/sessions/get?session_id=${sessionId}`);
                const sessResult = await sessResp.json();

                if (sessResult.success && sessResult.session && sessResult.session.messages.length > 0) {
                    let html = '<div class="p-3 space-y-2 max-h-[400px] overflow-y-auto">';
                    sessResult.session.messages.forEach(msg => {
                        const isUser = msg.role === 'user';
                        html += `
                            <div class="flex ${isUser ? 'justify-end' : 'justify-start'}">
                                <div class="max-w-[85%] p-2 rounded-lg ${isUser ? 'bg-blue-500/20 text-blue-200' : 'bg-slate-700 text-slate-200'}">
                                    <div class="text-xs font-medium mb-1 opacity-70">${isUser ? 'ğŸ‘¤ ä½ ' : 'ğŸ¤– AI'}</div>
                                    <div class="text-sm whitespace-pre-wrap">${msg.content}</div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    contentDiv.innerHTML = html;
                } else {
                    contentDiv.innerHTML = '<div class="p-3 text-slate-500 text-sm text-center">å¯¹è¯å†å²æœªæ‰¾åˆ°</div>';
                }
            } catch (error) {
                console.error('åŠ è½½å¯¹è¯å¤±è´¥:', error);
                contentDiv.innerHTML = '<div class="p-3 text-red-400 text-sm text-center">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // ===== åŠ è½½æ‰€æœ‰ä¼šè¯åˆ—è¡¨ =====
        async function loadSessionsList() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/sessions`);
                if (!response.ok) throw new Error('åŠ è½½å¤±è´¥');

                const result = await response.json();

                if (result.success && result.sessions && result.sessions.length > 0) {
                    sessionsList.innerHTML = result.sessions.map(s => {
                        const messageCount = s.messages ? s.messages.length : 0;
                        const lastMessage = s.messages && s.messages.length > 0
                            ? s.messages[s.messages.length - 1].content
                            : 'æš‚æ— æ¶ˆæ¯';
                        const preview = lastMessage.length > 50
                            ? lastMessage.substring(0, 50) + '...'
                            : lastMessage;

                        return `
                            <div class="session-item bg-slate-800/50 rounded-lg border border-slate-700/50 overflow-hidden" data-session-id="${s.id}">
                                <div class="item-header p-3 cursor-pointer hover:bg-slate-700/30 transition-colors" onclick="toggleSessionMessages('${s.id}', this)">
                                    <div class="flex items-start justify-between gap-2">
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center gap-2 mb-1">
                                                <span class="text-xs text-slate-500">${new Date(s.updated_at).toLocaleString()}</span>
                                                <span class="px-2 py-0.5 text-xs rounded-full bg-purple-500/20 text-purple-300">${messageCount} æ¡æ¶ˆæ¯</span>
                                            </div>
                                            <p class="text-sm text-slate-300">${preview}</p>
                                        </div>
                                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-500 flex-shrink-0 transition-transform duration-200"></i>
                                    </div>
                                </div>
                                <div class="session-messages hidden bg-slate-900/50 border-t border-slate-700/50" id="session-${s.id}">
                                    <div class="p-3 text-slate-500 text-sm text-center">åŠ è½½ä¸­...</div>
                                </div>
                            </div>
                        `;
                    }).join('');

                    lucide.createIcons();

                    // æ›´æ–°ç»Ÿè®¡
                    sessionsList.innerHTML += `
                        <div class="mt-3 pt-3 border-t border-slate-700 text-xs text-slate-500 text-center">
                            å…± ${result.count || result.sessions.length} ä¸ªå¯¹è¯
                        </div>
                    `;
                } else {
                    sessionsList.innerHTML = '<span class="text-slate-600 italic text-sm">æš‚æ— å¯¹è¯è®°å½•...</span>';
                }
            } catch (error) {
                console.error('åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥:', error);
                sessionsList.innerHTML = '<span class="text-red-400 italic text-sm">åŠ è½½å¤±è´¥: ' + error.message + '</span>';
            }
        }

        // å±•å¼€/æ”¶èµ·ä¼šè¯æ¶ˆæ¯
        async function toggleSessionMessages(sessionId, headerElement) {
            const messagesDiv = document.getElementById(`session-${sessionId}`);
            const chevronIcon = headerElement.querySelector('[data-lucide="chevron-down"]');

            // å¦‚æœå·²ç»å±•å¼€ï¼Œåˆ™æ”¶èµ·
            if (!messagesDiv.classList.contains('hidden')) {
                messagesDiv.classList.add('hidden');
                chevronIcon.style.transform = 'rotate(0deg)';
                return;
            }

            // å±•å¼€å¹¶æ˜¾ç¤ºæ¶ˆæ¯
            messagesDiv.classList.remove('hidden');
            chevronIcon.style.transform = 'rotate(180deg)';

            try {
                const sessResp = await fetch(`${API_BASE_URL}/api/sessions/get?session_id=${sessionId}`);
                const sessResult = await sessResp.json();

                if (sessResult.success && sessResult.session && sessResult.session.messages.length > 0) {
                    let html = '<div class="p-3 space-y-2 max-h-[400px] overflow-y-auto">';
                    sessResult.session.messages.forEach(msg => {
                        const isUser = msg.role === 'user';
                        html += `
                            <div class="flex ${isUser ? 'justify-end' : 'justify-start'}">
                                <div class="max-w-[85%] p-2 rounded-lg ${isUser ? 'bg-blue-500/20 text-blue-200' : 'bg-slate-700 text-slate-200'}">
                                    <div class="text-xs font-medium mb-1 opacity-70">${isUser ? 'ğŸ‘¤ ä½ ' : 'ğŸ¤– AI'}</div>
                                    <div class="text-sm whitespace-pre-wrap">${msg.content}</div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    messagesDiv.innerHTML = html;
                } else {
                    messagesDiv.innerHTML = '<div class="p-3 text-slate-500 text-sm text-center">æš‚æ— æ¶ˆæ¯</div>';
                }
            } catch (error) {
                console.error('åŠ è½½ä¼šè¯æ¶ˆæ¯å¤±è´¥:', error);
                messagesDiv.innerHTML = '<div class="p-3 text-red-400 text-sm text-center">åŠ è½½å¤±è´¥</div>';
            }
        }

        // ===== äº‹ä»¶ç›‘å¬ =====

        recordBtn.addEventListener('click', () => {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        });

        clearBtn.addEventListener('click', () => {
            transcript.value = '';
            aiReply.innerHTML = '<span class="text-slate-600 italic">AI å›å¤å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</span>';
            updateInputState();
            recordDuration.textContent = '0s';
            audioSize.textContent = '0 KB';
            lastAudioBlob = null;
            lastRecognizedText = '';
        });

        // è¾“å…¥æ¡†ç›‘å¬
        transcript.addEventListener('input', updateInputState);

        // Ctrl+Enter å‘é€åˆ° AI
        transcript.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                // æ£€æŸ¥æ˜¯å¦å¤„äºå‘é€çŠ¶æ€ï¼ˆè¾“å…¥æ¡†æˆ–å…¶ä»–æ§ä»¶è¢«ç¦ç”¨ï¼‰
                if (!sendBtn.disabled && !transcript.disabled) {
                    sendBtn.click();
                }
            }
        });

        // æ¸…ç©ºè¾“å…¥æŒ‰é’®
        clearInputBtn.addEventListener('click', () => {
            transcript.value = '';
            updateInputState();
        });

        saveKnowledgeBtn.addEventListener('click', saveToKnowledge);

        refreshKnowledgeBtn.addEventListener('click', loadKnowledgeList);
        refreshSessionsBtn.addEventListener('click', loadSessionsList);

        sendBtn.addEventListener('click', async () => {
            // ä½¿ç”¨ç¼–è¾‘åçš„æ–‡æœ¬
            const text = lastRecognizedText.trim();
            if (text) {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€å¹¶ç¦ç”¨æ‰€æœ‰è¾“å…¥æ§ä»¶
                setSendingState(true);

                try {
                    // ä½¿ç”¨ SSE æµå¼å“åº”
                    await sendChatWithSSE(text);
                } catch (error) {
                    console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                    aiReply.innerHTML = `<span class="text-red-400">é”™è¯¯: ${error.message}</span>`;
                    setSendingState(false);
                }
            } else {
                alert('è¯·å…ˆå½•åˆ¶æˆ–è¾“å…¥ä¸€äº›æ–‡å­—');
            }
        });

        // è®¾ç½®å‘é€çŠ¶æ€ï¼ˆç¦ç”¨/å¯ç”¨æ‰€æœ‰è¾“å…¥æ§ä»¶ï¼‰
        function setSendingState(isSending) {
            sendBtn.disabled = isSending;
            playVoiceBtn.disabled = isSending;
            transcript.disabled = isSending;
            clearInputBtn.disabled = isSending;

            if (isSending) {
                transcript.classList.add('opacity-50');
                aiReply.innerHTML = `<span class="text-yellow-400 flex items-center gap-2">
                    <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    æ­£åœ¨æ€è€ƒ...
                </span>`;
            } else {
                transcript.classList.remove('opacity-50');
            }
        }

        // ===== SSE æµå¼èŠå¤© =====
        async function sendChatWithSSE(text) {
            let fullReply = '';

            const response = await fetch(`${API_BASE_URL}/api/chat/stream`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: text,
                    session_id: sessionId || ''
                    // æ³¨é‡Šï¼šä¸è‡ªåŠ¨ç”Ÿæˆ TTSï¼Œç”¨æˆ·ç‚¹å‡»"æ’­æ”¾è¯­éŸ³"æŒ‰é’®æ—¶æ‰è°ƒç”¨
                    // include_audio: true
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            // æ¸…ç©ºå¹¶å‡†å¤‡æ˜¾ç¤ºæµå¼å†…å®¹
            aiReply.innerHTML = '<span class="text-white"></span>';
            const contentSpan = aiReply.querySelector('span');

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const jsonStr = line.slice(6);
                        try {
                            const data = JSON.parse(jsonStr);

                            if (data.type === 'content') {
                                // æµå¼æ–‡æœ¬å†…å®¹
                                fullReply += data.delta;
                                contentSpan.textContent = fullReply;
                                // è‡ªåŠ¨æ»šåŠ¨
                                contentSpan.scrollIntoView({ behavior: 'smooth', block: 'end' });
                            } else if (data.type === 'done') {
                                // æµç»“æŸ
                                console.log('æµå¼å“åº”å®Œæˆ');
                                sessionId = data.session_id;
                                lastAiReply = fullReply;
                                // æ¢å¤è¾“å…¥çŠ¶æ€
                                setSendingState(false);

                                // æ¸…é™¤æ—§çš„ TTS ç¼“å­˜
                                cachedTTSUrl = null;
                                console.log('å·²æ¸…é™¤æ—§çš„ TTS ç¼“å­˜');
                            } else if (data.type === 'error') {
                                throw new Error(data.error);
                            }
                        } catch (e) {
                            console.error('è§£æ SSE æ•°æ®å¤±è´¥:', e, jsonStr);
                        }
                    }
                }
            }
        }

        micSelect.addEventListener('change', (e) => {
            selectedDeviceId = e.target.value;
            console.log('é€‰æ‹©éº¦å…‹é£:', e.target.options[e.target.selectedIndex].text);
        });

        // ===== TTS ç¼“å­˜ =====
        // ç¼“å­˜ TTS éŸ³é¢‘ URLï¼Œé¿å…é‡å¤ç”Ÿæˆ
        let cachedTTSUrl = null;

        // ===== æ’­æ”¾è¯­éŸ³æŒ‰é’® - è°ƒç”¨ç™¾åº¦ TTS API =====
        playVoiceBtn.addEventListener('click', async () => {
            if (!lastAiReply) {
                alert('è¯·å…ˆè¿›è¡Œ AI å¯¹è¯');
                return;
            }

            // å¦‚æœæœ‰ç¼“å­˜çš„éŸ³é¢‘ URLï¼Œç›´æ¥æ’­æ”¾
            if (cachedTTSUrl) {
                console.log('ä½¿ç”¨ç¼“å­˜çš„ TTS éŸ³é¢‘:', cachedTTSUrl);
                audioPlayer.src = cachedTTSUrl;
                audioPlayer.style.display = 'block';

                playVoiceBtn.disabled = true;
                playVoiceBtn.innerHTML = '<i data-lucide="volume-2" class="w-3 h-3"></i> æ’­æ”¾ä¸­...';
                lucide.createIcons();

                try {
                    await audioPlayer.play();

                    audioPlayer.onended = () => {
                        console.log('TTS æ’­æ”¾å®Œæˆ');
                        playVoiceBtn.disabled = false;
                        playVoiceBtn.innerHTML = '<i data-lucide="volume-2" class="w-3 h-3"></i> æ’­æ”¾è¯­éŸ³';
                        lucide.createIcons();
                    };

                    audioPlayer.onerror = () => {
                        console.error('TTS æ’­æ”¾å¤±è´¥ï¼Œå°è¯•é‡æ–°ç”Ÿæˆ');
                        cachedTTSUrl = null; // æ¸…é™¤ç¼“å­˜
                        playVoiceBtn.click(); // é€’å½’è°ƒç”¨é‡æ–°ç”Ÿæˆ
                    };
                } catch (error) {
                    console.error('æ’­æ”¾å¤±è´¥:', error);
                    cachedTTSUrl = null;
                    playVoiceBtn.disabled = false;
                    playVoiceBtn.innerHTML = '<i data-lucide="volume-2" class="w-3 h-3"></i> æ’­æ”¾è¯­éŸ³';
                    lucide.createIcons();
                }
                return;
            }

            // æ²¡æœ‰ç¼“å­˜ï¼Œè°ƒç”¨ TTS API ç”Ÿæˆ
            try {
                playVoiceBtn.disabled = true;
                playVoiceBtn.innerHTML = '<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> ç”Ÿæˆä¸­...';
                lucide.createIcons();

                // è°ƒç”¨ç™¾åº¦ TTS APIï¼Œä¼ é€’ session_id
                const params = new URLSearchParams({
                    text: lastAiReply,
                    session_id: sessionId || ''
                });
                const response = await fetch(`${API_BASE_URL}/api/tts?${params}`);

                if (!response.ok) {
                    throw new Error(`TTS è¯·æ±‚å¤±è´¥: ${response.status}`);
                }

                const result = await response.json();

                if (!result.success || !result.audio_url) {
                    throw new Error('TTS ç”Ÿæˆå¤±è´¥');
                }

                // æ„å»ºå®Œæ•´çš„éŸ³é¢‘ URL
                const fullAudioUrl = result.audio_url.startsWith('http')
                    ? result.audio_url
                    : `${API_BASE_URL}/${result.audio_url.replace(/^\//, '')}`;

                // ç¼“å­˜éŸ³é¢‘ URL
                cachedTTSUrl = fullAudioUrl;
                console.log('TTS éŸ³é¢‘å·²ç¼“å­˜:', fullAudioUrl);

                // æ’­æ”¾éŸ³é¢‘
                audioPlayer.src = fullAudioUrl;
                audioPlayer.style.display = 'block';

                playVoiceBtn.innerHTML = '<i data-lucide="volume-2" class="w-3 h-3"></i> æ’­æ”¾ä¸­...';
                lucide.createIcons();

                await audioPlayer.play();

                audioPlayer.onended = () => {
                    console.log('TTS æ’­æ”¾å®Œæˆ');
                    playVoiceBtn.disabled = false;
                    playVoiceBtn.innerHTML = '<i data-lucide="volume-2" class="w-3 h-3"></i> æ’­æ”¾è¯­éŸ³';
                    lucide.createIcons();
                };

                audioPlayer.onerror = () => {
                    console.error('TTS æ’­æ”¾å¤±è´¥');
                    cachedTTSUrl = null;
                    playVoiceBtn.disabled = false;
                    playVoiceBtn.innerHTML = '<i data-lucide="volume-2" class="w-3 h-3"></i> æ’­æ”¾è¯­éŸ³';
                    lucide.createIcons();
                    alert('éŸ³é¢‘æ’­æ”¾å¤±è´¥ï¼Œè¯·é‡è¯•');
                };

            } catch (error) {
                console.error('TTS è¯·æ±‚å¤±è´¥:', error);
                cachedTTSUrl = null;
                playVoiceBtn.disabled = false;
                playVoiceBtn.innerHTML = '<i data-lucide="volume-2" class="w-3 h-3"></i> æ’­æ”¾è¯­éŸ³';
                lucide.createIcons();
                alert('è¯­éŸ³åˆæˆå¤±è´¥: ' + error.message);
            }
        });

        // ä¿ç•™æ—§çš„æµè§ˆå™¨ TTS ä½œä¸ºå¤‡ç”¨ï¼ˆæ³¨é‡Šï¼‰
        /*
        playVoiceBtn.addEventListener('click', () => {
            if (lastAiReply && 'speechSynthesis' in window) {
                // å–æ¶ˆå½“å‰æ­£åœ¨æ’­æ”¾çš„
                window.speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(lastAiReply);
                utterance.lang = 'zh-CN';
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;

                // å°è¯•é€‰æ‹©ä¸­æ–‡è¯­éŸ³
                const voices = window.speechSynthesis.getVoices();
                const chineseVoice = voices.find(v => v.lang.includes('zh')) || voices.find(v => v.lang.includes('CN'));
                if (chineseVoice) {
                    utterance.voice = chineseVoice;
                }

                utterance.onstart = () => {
                    playVoiceBtn.innerHTML = '<i data-lucide="volume-2" class="w-3 h-3"></i> æ’­æ”¾ä¸­...';
                    lucide.createIcons();
                };

                utterance.onend = () => {
                    playVoiceBtn.innerHTML = '<i data-lucide="volume-2" class="w-3 h-3"></i> æ’­æ”¾è¯­éŸ³';
                    lucide.createIcons();
                };

                window.speechSynthesis.speak(utterance);
                console.log('æ’­æ”¾ TTS:', lastAiReply);
            }
        });
        */

        // ===== åˆå§‹åŒ– =====
        (async function init() {
            await checkBackend();
            await enumerateMicrophones();
            await loadKnowledgeList();  // åŠ è½½çŸ¥è¯†åº“åˆ—è¡¨
            await loadSessionsList();   // åŠ è½½ä¼šè¯åˆ—è¡¨
        })();

        console.log('Voice Memory STT Demo (WAV) åˆå§‹åŒ–å®Œæˆ');
    </script>
</body>
</html>
